# =============================================================================
# CIS UBUNTU 24.04 LTS COMPLIANCE QUERIES FOR FLEET - COMPLETE MASTER FILE
# =============================================================================
#
# This master file contains ALL osquery-based compliance queries for the
# CIS Ubuntu Linux 24.04 LTS Benchmark v1.0.0
#
# IMPORTANT: These queries are designed to work with Fleet's supported osquery
# tables and return 1 for compliant devices, 0 for non-compliant.
#
# TOTAL POLICIES: 150+ comprehensive security controls
# LEVELS: Both Level 1 (basic) and Level 2 (advanced) controls included
#
# All queries use only Fleet-supported osquery tables as documented at:
# https://fleetdm.com/tables and https://www.osquery.io/schema/
#
# =============================================================================
# SECTION 1: INITIAL SETUP - FILESYSTEM CONFIGURATION
# =============================================================================

apiVersion: v1
kind: policy
spec:
  name: CIS - /tmp is a separate partition
  platforms: Linux
  platform: linux
  description: |
    The /tmp directory is a world-writable directory used for temporary storage by all users and some applications.
  resolution: |
    Create a separate partition for /tmp and configure it in /etc/fstab.
    Example: tmpfs /tmp tmpfs defaults,rw,nosuid,nodev,noexec,relatime,size=2G 0 0
  query: |
    SELECT 1 WHERE EXISTS (
      SELECT * FROM mounts WHERE path = '/tmp'
    );
  purpose: Informational
  tags: compliance, CIS, CIS_Level1, CIS-ubuntu-24.04-1.1.2.1.1
  contributors: allenhouchins

---
apiVersion: v1
kind: policy
spec:
  name: CIS - nodev option set on /tmp partition
  platforms: Linux
  platform: linux
  description: |
    The nodev mount option specifies that the filesystem cannot contain special devices.
  resolution: |
    Edit /etc/fstab and add nodev to the mount options for /tmp.
    Run: mount -o remount /tmp
  query: |
    SELECT 1 WHERE EXISTS (
      SELECT * FROM mounts 
      WHERE path = '/tmp' 
      AND flags LIKE '%nodev%'
    );
  purpose: Informational
  tags: compliance, CIS, CIS_Level1, CIS-ubuntu-24.04-1.1.2.1.2
  contributors: allenhouchins

---
apiVersion: v1
kind: policy
spec:
  name: CIS - noexec option set on /tmp partition
  platforms: Linux
  platform: linux
  description: |
    The noexec mount option specifies that the filesystem cannot contain executable binaries.
  resolution: |
    Edit /etc/fstab and add noexec to the mount options for /tmp.
    Run: mount -o remount /tmp
  query: |
    SELECT 1 WHERE EXISTS (
      SELECT * FROM mounts 
      WHERE path = '/tmp' 
      AND flags LIKE '%noexec%'
    );
  purpose: Informational
  tags: compliance, CIS, CIS_Level1, CIS-ubuntu-24.04-1.1.2.1.3
  contributors: allenhouchins

---
apiVersion: v1
kind: policy
spec:
  name: CIS - nosuid option set on /tmp partition
  platforms: Linux
  platform: linux
  description: |
    The nosuid mount option specifies that the filesystem cannot contain setuid files.
  resolution: |
    Edit /etc/fstab and add nosuid to the mount options for /tmp.
    Run: mount -o remount /tmp
  query: |
    SELECT 1 WHERE EXISTS (
      SELECT * FROM mounts 
      WHERE path = '/tmp' 
      AND flags LIKE '%nosuid%'
    );
  purpose: Informational
  tags: compliance, CIS, CIS_Level1, CIS-ubuntu-24.04-1.1.2.1.4
  contributors: allenhouchins

---
apiVersion: v1
kind: policy
spec:
  name: CIS - separate partition exists for /var
  platforms: Linux
  platform: linux
  description: |
    The /var directory is used by daemons and other system services to store frequently-changing data.
  resolution: |
    For new installations, create a custom partition setup and specify a separate partition for /var.
  query: |
    SELECT 1 WHERE EXISTS (
      SELECT * FROM mounts WHERE path = '/var'
    );
  purpose: Informational
  tags: compliance, CIS, CIS_Level2, CIS-ubuntu-24.04-1.1.2.2.1
  contributors: allenhouchins

---
apiVersion: v1
kind: policy
spec:
  name: CIS - nodev option set on /var partition
  platforms: Linux
  platform: linux
  description: |
    The nodev mount option specifies that the filesystem cannot contain special devices.
  resolution: |
    Edit /etc/fstab and add nodev to the mount options for /var.
    Run: mount -o remount /var
  query: |
    SELECT 1 WHERE EXISTS (
      SELECT * FROM mounts 
      WHERE path = '/var' 
      AND flags LIKE '%nodev%'
    );
  purpose: Informational
  tags: compliance, CIS, CIS_Level2, CIS-ubuntu-24.04-1.1.2.2.2
  contributors: allenhouchins

---
apiVersion: v1
kind: policy
spec:
  name: CIS - nosuid option set on /var partition
  platforms: Linux
  platform: linux
  description: |
    The nosuid mount option specifies that the filesystem cannot contain setuid files.
  resolution: |
    Edit /etc/fstab and add nosuid to the mount options for /var.
    Run: mount -o remount /var
  query: |
    SELECT 1 WHERE EXISTS (
      SELECT * FROM mounts 
      WHERE path = '/var' 
      AND flags LIKE '%nosuid%'
    );
  purpose: Informational
  tags: compliance, CIS, CIS_Level2, CIS-ubuntu-24.04-1.1.2.2.3
  contributors: allenhouchins

---
apiVersion: v1
kind: policy
spec:
  name: CIS - separate partition exists for /var/tmp
  platforms: Linux
  platform: linux
  description: |
    The /var/tmp directory is a world-writable directory used for temporary storage by all users and some applications.
  resolution: |
    For new installations, create a custom partition setup and specify a separate partition for /var/tmp.
  query: |
    SELECT 1 WHERE EXISTS (
      SELECT * FROM mounts WHERE path = '/var/tmp'
    );
  purpose: Informational
  tags: compliance, CIS, CIS_Level2, CIS-ubuntu-24.04-1.1.2.3.1
  contributors: allenhouchins

---
apiVersion: v1
kind: policy
spec:
  name: CIS - nodev option set on /var/tmp partition
  platforms: Linux
  platform: linux
  description: |
    The nodev mount option specifies that the filesystem cannot contain special devices.
  resolution: |
    Edit /etc/fstab and add nodev to the mount options for /var/tmp.
    Run: mount -o remount /var/tmp
  query: |
    SELECT 1 WHERE EXISTS (
      SELECT * FROM mounts 
      WHERE path = '/var/tmp' 
      AND flags LIKE '%nodev%'
    );
  purpose: Informational
  tags: compliance, CIS, CIS_Level2, CIS-ubuntu-24.04-1.1.2.3.2
  contributors: allenhouchins

---
apiVersion: v1
kind: policy
spec:
  name: CIS - noexec option set on /var/tmp partition
  platforms: Linux
  platform: linux
  description: |
    The noexec mount option specifies that the filesystem cannot contain executable binaries.
  resolution: |
    Edit /etc/fstab and add noexec to the mount options for /var/tmp.
    Run: mount -o remount /var/tmp
  query: |
    SELECT 1 WHERE EXISTS (
      SELECT * FROM mounts 
      WHERE path = '/var/tmp' 
      AND flags LIKE '%noexec%'
    );
  purpose: Informational
  tags: compliance, CIS, CIS_Level2, CIS-ubuntu-24.04-1.1.2.3.3
  contributors: allenhouchins

---
apiVersion: v1
kind: policy
spec:
  name: CIS - nosuid option set on /var/tmp partition
  platforms: Linux
  platform: linux
  description: |
    The nosuid mount option specifies that the filesystem cannot contain setuid files.
  resolution: |
    Edit /etc/fstab and add nosuid to the mount options for /var/tmp.
    Run: mount -o remount /var/tmp
  query: |
    SELECT 1 WHERE EXISTS (
      SELECT * FROM mounts 
      WHERE path = '/var/tmp' 
      AND flags LIKE '%nosuid%'
    );
  purpose: Informational
  tags: compliance, CIS, CIS_Level2, CIS-ubuntu-24.04-1.1.2.3.4
  contributors: allenhouchins

---
apiVersion: v1
kind: policy
spec:
  name: CIS - separate partition exists for /var/log
  platforms: Linux
  platform: linux
  description: |
    The /var/log directory is used by system services to store log data.
  resolution: |
    For new installations, create a custom partition setup and specify a separate partition for /var/log.
  query: |
    SELECT 1 WHERE EXISTS (
      SELECT * FROM mounts WHERE path = '/var/log'
    );
  purpose: Informational
  tags: compliance, CIS, CIS_Level2, CIS-ubuntu-24.04-1.1.2.4.1
  contributors: allenhouchins

---
apiVersion: v1
kind: policy
spec:
  name: CIS - nodev option set on /var/log partition
  platforms: Linux
  platform: linux
  description: |
    The nodev mount option specifies that the filesystem cannot contain special devices.
  resolution: |
    Edit /etc/fstab and add nodev to the mount options for /var/log.
    Run: mount -o remount /var/log
  query: |
    SELECT 1 WHERE EXISTS (
      SELECT * FROM mounts 
      WHERE path = '/var/log' 
      AND flags LIKE '%nodev%'
    );
  purpose: Informational
  tags: compliance, CIS, CIS_Level2, CIS-ubuntu-24.04-1.1.2.4.2
  contributors: allenhouchins

---
apiVersion: v1
kind: policy
spec:
  name: CIS - noexec option set on /var/log partition
  platforms: Linux
  platform: linux
  description: |
    The noexec mount option specifies that the filesystem cannot contain executable binaries.
  resolution: |
    Edit /etc/fstab and add noexec to the mount options for /var/log.
    Run: mount -o remount /var/log
  query: |
    SELECT 1 WHERE EXISTS (
      SELECT * FROM mounts 
      WHERE path = '/var/log' 
      AND flags LIKE '%noexec%'
    );
  purpose: Informational
  tags: compliance, CIS, CIS_Level2, CIS-ubuntu-24.04-1.1.2.4.3
  contributors: allenhouchins

---
apiVersion: v1
kind: policy
spec:
  name: CIS - nosuid option set on /var/log partition
  platforms: Linux
  platform: linux
  description: |
    The nosuid mount option specifies that the filesystem cannot contain setuid files.
  resolution: |
    Edit /etc/fstab and add nosuid to the mount options for /var/log.
    Run: mount -o remount /var/log
  query: |
    SELECT 1 WHERE EXISTS (
      SELECT * FROM mounts 
      WHERE path = '/var/log' 
      AND flags LIKE '%nosuid%'
    );
  purpose: Informational
  tags: compliance, CIS, CIS_Level2, CIS-ubuntu-24.04-1.1.2.4.4
  contributors: allenhouchins

---
apiVersion: v1
kind: policy
spec:
  name: CIS - separate partition exists for /var/log/audit
  platforms: Linux
  platform: linux
  description: |
    The auditing daemon stores log data in the /var/log/audit directory.
  resolution: |
    For new installations, create a custom partition setup and specify a separate partition for /var/log/audit.
  query: |
    SELECT 1 WHERE EXISTS (
      SELECT * FROM mounts WHERE path = '/var/log/audit'
    );
  purpose: Informational
  tags: compliance, CIS, CIS_Level2, CIS-ubuntu-24.04-1.1.2.5.1
  contributors: allenhouchins

---
apiVersion: v1
kind: policy
spec:
  name: CIS - nodev option set on /var/log/audit partition
  platforms: Linux
  platform: linux
  description: |
    The nodev mount option specifies that the filesystem cannot contain special devices.
  resolution: |
    Edit /etc/fstab and add nodev to the mount options for /var/log/audit.
    Run: mount -o remount /var/log/audit
  query: |
    SELECT 1 WHERE EXISTS (
      SELECT * FROM mounts 
      WHERE path = '/var/log/audit' 
      AND flags LIKE '%nodev%'
    );
  purpose: Informational
  tags: compliance, CIS, CIS_Level2, CIS-ubuntu-24.04-1.1.2.5.2
  contributors: allenhouchins

---
apiVersion: v1
kind: policy
spec:
  name: CIS - noexec option set on /var/log/audit partition
  platforms: Linux
  platform: linux
  description: |
    The noexec mount option specifies that the filesystem cannot contain executable binaries.
  resolution: |
    Edit /etc/fstab and add noexec to the mount options for /var/log/audit.
    Run: mount -o remount /var/log/audit
  query: |
    SELECT 1 WHERE EXISTS (
      SELECT * FROM mounts 
      WHERE path = '/var/log/audit' 
      AND flags LIKE '%noexec%'
    );
  purpose: Informational
  tags: compliance, CIS, CIS_Level2, CIS-ubuntu-24.04-1.1.2.5.3
  contributors: allenhouchins

---
apiVersion: v1
kind: policy
spec:
  name: CIS - nosuid option set on /var/log/audit partition
  platforms: Linux
  platform: linux
  description: |
    The nosuid mount option specifies that the filesystem cannot contain setuid files.
  resolution: |
    Edit /etc/fstab and add nosuid to the mount options for /var/log/audit.
    Run: mount -o remount /var/log/audit
  query: |
    SELECT 1 WHERE EXISTS (
      SELECT * FROM mounts 
      WHERE path = '/var/log/audit' 
      AND flags LIKE '%nosuid%'
    );
  purpose: Informational
  tags: compliance, CIS, CIS_Level2, CIS-ubuntu-24.04-1.1.2.5.4
  contributors: allenhouchins

---
apiVersion: v1
kind: policy
spec:
  name: CIS - separate partition exists for /home
  platforms: Linux
  platform: linux
  description: |
    The /home directory is used to support disk storage needs of local users.
  resolution: |
    For new installations, create a custom partition setup and specify a separate partition for /home.
  query: |
    SELECT 1 WHERE EXISTS (
      SELECT * FROM mounts WHERE path = '/home'
    );
  purpose: Informational
  tags: compliance, CIS, CIS_Level2, CIS-ubuntu-24.04-1.1.2.6.1
  contributors: allenhouchins

---
apiVersion: v1
kind: policy
spec:
  name: CIS - nodev option set on /home partition
  platforms: Linux
  platform: linux
  description: |
    The nodev mount option specifies that the filesystem cannot contain special devices.
  resolution: |
    Edit /etc/fstab and add nodev to the mount options for /home.
    Run: mount -o remount /home
  query: |
    SELECT 1 WHERE EXISTS (
      SELECT * FROM mounts 
      WHERE path = '/home' 
      AND flags LIKE '%nodev%'
    );
  purpose: Informational
  tags: compliance, CIS, CIS_Level2, CIS-ubuntu-24.04-1.1.2.6.2
  contributors: allenhouchins

---
apiVersion: v1
kind: policy
spec:
  name: CIS - nosuid option set on /home partition
  platforms: Linux
  platform: linux
  description: |
    The nosuid mount option specifies that the filesystem cannot contain setuid files.
  resolution: |
    Edit /etc/fstab and add nosuid to the mount options for /home.
    Run: mount -o remount /home
  query: |
    SELECT 1 WHERE EXISTS (
      SELECT * FROM mounts 
      WHERE path = '/home' 
      AND flags LIKE '%nosuid%'
    );
  purpose: Informational
  tags: compliance, CIS, CIS_Level2, CIS-ubuntu-24.04-1.1.2.6.3
  contributors: allenhouchins

---
apiVersion: v1
kind: policy
spec:
  name: CIS - nodev option set on /dev/shm partition
  platforms: Linux
  platform: linux
  description: |
    The nodev mount option specifies that the filesystem cannot contain special devices.
  resolution: |
    Edit /etc/fstab and add nodev to the mount options for /dev/shm.
    Run: mount -o remount /dev/shm
  query: |
    SELECT 1 WHERE EXISTS (
      SELECT * FROM mounts 
      WHERE path = '/dev/shm' 
      AND flags LIKE '%nodev%'
    );
  purpose: Informational
  tags: compliance, CIS, CIS_Level1, CIS-ubuntu-24.04-1.1.2.7.1
  contributors: allenhouchins

---
apiVersion: v1
kind: policy
spec:
  name: CIS - noexec option set on /dev/shm partition
  platforms: Linux
  platform: linux
  description: |
    The noexec mount option specifies that the filesystem cannot contain executable binaries.
  resolution: |
    Edit /etc/fstab and add noexec to the mount options for /dev/shm.
    Run: mount -o remount /dev/shm
  query: |
    SELECT 1 WHERE EXISTS (
      SELECT * FROM mounts 
      WHERE path = '/dev/shm' 
      AND flags LIKE '%noexec%'
    );
  purpose: Informational
  tags: compliance, CIS, CIS_Level1, CIS-ubuntu-24.04-1.1.2.7.2
  contributors: allenhouchins

---
apiVersion: v1
kind: policy
spec:
  name: CIS - nosuid option set on /dev/shm partition
  platforms: Linux
  platform: linux
  description: |
    The nosuid mount option specifies that the filesystem cannot contain setuid files.
  resolution: |
    Edit /etc/fstab and add nosuid to the mount options for /dev/shm.
    Run: mount -o remount /dev/shm
  query: |
    SELECT 1 WHERE EXISTS (
      SELECT * FROM mounts 
      WHERE path = '/dev/shm' 
      AND flags LIKE '%nosuid%'
    );
  purpose: Informational
  tags: compliance, CIS, CIS_Level1, CIS-ubuntu-24.04-1.1.2.7.3
  contributors: allenhouchins

# =============================================================================
# SECTION 1: INITIAL SETUP - CONFIGURE SOFTWARE UPDATES
# =============================================================================

---
apiVersion: v1
kind: policy
spec:
  name: CIS - package manager repositories are configured
  platforms: Linux
  platform: linux
  description: |
    Systems need to have package manager repositories configured to ensure they receive the latest patches.
  resolution: |
    Configure your package manager repositories according to site policy.
  query: |
    SELECT 1 WHERE EXISTS (
      SELECT * FROM file WHERE path = '/etc/apt/sources.list' AND size > 0
    ) OR EXISTS (
      SELECT * FROM file WHERE path LIKE '/etc/apt/sources.list.d/%.list' AND size > 0
    );
  purpose: Informational
  tags: compliance, CIS, CIS_Level1, CIS-ubuntu-24.04-1.2.1
  contributors: allenhouchins

---
apiVersion: v1
kind: policy
spec:
  name: CIS - GPG keys are configured
  platforms: Linux
  platform: linux
  description: |
    Most packages managers implement GPG key signing to verify package integrity during installation.
  resolution: |
    Update your package manager GPG keys according to site policy.
  query: |
    SELECT 1 WHERE EXISTS (
      SELECT * FROM file WHERE path LIKE '/etc/apt/trusted.gpg%'
    ) OR EXISTS (
      SELECT * FROM file WHERE path LIKE '/usr/share/keyrings/%'
    );
  purpose: Informational
  tags: compliance, CIS, CIS_Level1, CIS-ubuntu-24.04-1.2.2
  contributors: allenhouchins

# =============================================================================
# SECTION 1: INITIAL SETUP - MANDATORY ACCESS CONTROL
# =============================================================================

---
apiVersion: v1
kind: policy
spec:
  name: CIS - AppArmor is installed
  platforms: Linux
  platform: linux
  description: |
    AppArmor is a Linux Kernel Security Module that provides mandatory access controls.
  resolution: |
    Install AppArmor:
    # apt install apparmor apparmor-utils
  query: |
    SELECT 1 WHERE EXISTS (
      SELECT * FROM deb_packages WHERE name = 'apparmor' AND status = 'install ok installed'
    );
  purpose: Informational
  tags: compliance, CIS, CIS_Level1, CIS-ubuntu-24.04-1.3.1.1
  contributors: allenhouchins

---
apiVersion: v1
kind: policy
spec:
  name: CIS - AppArmor is enabled in the bootloader configuration
  platforms: Linux
  platform: linux
  description: |
    Configure AppArmor to be enabled at boot time and verify it is not overwritten by the bootloader boot parameters.
  resolution: |
    Edit /etc/default/grub and add the following parameters to GRUB_CMDLINE_LINUX:
    apparmor=1 security=apparmor
    Run: update-grub
  query: |
    SELECT 1 WHERE EXISTS (
      SELECT * FROM kernel_info 
      WHERE arguments LIKE '%apparmor=1%'
      AND arguments LIKE '%security=apparmor%'
    );
  purpose: Informational
  tags: compliance, CIS, CIS_Level1, CIS-ubuntu-24.04-1.3.1.2
  contributors: allenhouchins

---
apiVersion: v1
kind: policy
spec:
  name: CIS - all AppArmor Profiles are in enforce or complain mode
  platforms: Linux
  platform: linux
  description: |
    AppArmor profiles define what resources applications can access.
  resolution: |
    Run the following command to set all profiles to enforce mode:
    # aa-enforce /etc/apparmor.d/*
  query: |
    SELECT 1 WHERE NOT EXISTS (
      SELECT * FROM apparmor_profiles WHERE mode = 'unconfined'
    );
  purpose: Informational
  tags: compliance, CIS, CIS_Level1, CIS-ubuntu-24.04-1.3.1.3
  contributors: allenhouchins

---
apiVersion: v1
kind: policy
spec:
  name: CIS - all AppArmor Profiles are enforcing
  platforms: Linux
  platform: linux
  description: |
    Security configuration requirements vary from site to site.
  resolution: |
    Run the following command to set all profiles to enforce mode:
    # aa-enforce /etc/apparmor.d/*
  query: |
    SELECT 1 WHERE NOT EXISTS (
      SELECT * FROM apparmor_profiles WHERE mode = 'complain'
    );
  purpose: Informational
  tags: compliance, CIS, CIS_Level2, CIS-ubuntu-24.04-1.3.1.4
  contributors: allenhouchins

# =============================================================================
# SECTION 1: INITIAL SETUP - BOOTLOADER CONFIGURATION
# =============================================================================

---
apiVersion: v1
kind: policy
spec:
  name: CIS - bootloader password is set
  platforms: Linux
  platform: linux
  description: |
    Setting the boot loader password will require that anyone rebooting the system must enter a password before being able to set command line boot parameters.
  resolution: |
    Create an encrypted password with grub-mkpasswd-pbkdf2:
    # grub-mkpasswd-pbkdf2
    Add the following to /etc/grub.d/40_custom:
    set superusers="<username>"
    password_pbkdf2 <username> <encrypted-password>
    Run: update-grub
  query: |
    SELECT 1 WHERE EXISTS (
      SELECT * FROM file 
      WHERE path LIKE '/etc/grub.d/%' 
      AND filename LIKE '%custom%'
    );
  purpose: Informational
  tags: compliance, CIS, CIS_Level1, CIS-ubuntu-24.04-1.4.1
  contributors: allenhouchins

---
apiVersion: v1
kind: policy
spec:
  name: CIS - permissions on bootloader config are configured
  platforms: Linux
  platform: linux
  description: |
    Setting the permissions to read and write for root only prevents non-root users from seeing the bootloader configuration.
  resolution: |
    Run the following commands:
    # chown root:root /boot/grub/grub.cfg
    # chmod og-rwx /boot/grub/grub.cfg
  query: |
    SELECT 1 WHERE EXISTS (
      SELECT * FROM file 
      WHERE path = '/boot/grub/grub.cfg' 
      AND uid = 0 
      AND gid = 0 
      AND mode = '0400'
    ) OR NOT EXISTS (
      SELECT * FROM file WHERE path = '/boot/grub/grub.cfg'
    );
  purpose: Informational
  tags: compliance, CIS, CIS_Level1, CIS-ubuntu-24.04-1.4.2
  contributors: allenhouchins

# =============================================================================
# SECTION 1: INITIAL SETUP - PROCESS HARDENING
# =============================================================================

---
apiVersion: v1
kind: policy
spec:
  name: CIS - address space layout randomization (ASLR) is enabled
  platforms: Linux
  platform: linux
  description: |
    Address space layout randomization (ASLR) is an exploit mitigation technique.
  resolution: |
    Set the following parameters in /etc/sysctl.conf or a /etc/sysctl.d/* file:
    kernel.randomize_va_space = 2
    Run: sysctl -w kernel.randomize_va_space=2
  query: |
    SELECT 1 WHERE EXISTS (
      SELECT * FROM system_controls 
      WHERE name = 'kernel.randomize_va_space' 
      AND current_value = '2'
    );
  purpose: Informational
  tags: compliance, CIS, CIS_Level1, CIS-ubuntu-24.04-1.5.1
  contributors: allenhouchins

---
apiVersion: v1
kind: policy
spec:
  name: CIS - prelink is not installed
  platforms: Linux
  platform: linux
  description: |
    prelink is a program that modifies ELF shared libraries and ELF dynamically linked binaries.
  resolution: |
    Restore binaries to normal and uninstall prelink:
    # prelink -ua
    # apt purge prelink
  query: |
    SELECT 1 WHERE NOT EXISTS (
      SELECT * FROM deb_packages WHERE name = 'prelink' AND status = 'install ok installed'
    );
  purpose: Informational
  tags: compliance, CIS, CIS_Level1, CIS-ubuntu-24.04-1.5.2
  contributors: allenhouchins

---
apiVersion: v1
kind: policy
spec:
  name: CIS - Automatic Error Reporting is not enabled
  platforms: Linux
  platform: linux
  description: |
    The Apport Error Reporting Service is used to automatically generate crash reports.
  resolution: |
    Edit /etc/default/apport and set enabled=0
    OR remove the package:
    # apt purge apport
  query: |
    SELECT 1 WHERE NOT EXISTS (
      SELECT * FROM systemd_units 
      WHERE id = 'apport.service' 
      AND active_state = 'active'
    );
  purpose: Informational
  tags: compliance, CIS, CIS_Level1, CIS-ubuntu-24.04-1.5.3
  contributors: allenhouchins

---
apiVersion: v1
kind: policy
spec:
  name: CIS - core dumps are restricted
  platforms: Linux
  platform: linux
  description: |
    A core dump is the memory of an executable program that is written to a file at the time of a crash.
  resolution: |
    Add the following line to /etc/security/limits.conf or a /etc/security/limits.d/* file:
    * hard core 0
    Set the following parameter in /etc/sysctl.conf or a /etc/sysctl.d/* file:
    fs.suid_dumpable = 0
  query: |
    SELECT 1 WHERE EXISTS (
      SELECT * FROM system_controls 
      WHERE name = 'fs.suid_dumpable' 
      AND current_value = '0'
    );
  purpose: Informational
  tags: compliance, CIS, CIS_Level1, CIS-ubuntu-24.04-1.5.4
  contributors: allenhouchins

# =============================================================================
# SECTION 1: INITIAL SETUP - ACCESS CONTROL
# =============================================================================

---
apiVersion: v1
kind: policy
spec:
  name: CIS - permissions on /etc/motd are configured
  platforms: Linux
  platform: linux
  description: |
    The contents of the /etc/motd file are displayed to users after login.
  resolution: |
    Run the following commands:
    # chown root:root /etc/motd
    # chmod 644 /etc/motd
  query: |
    SELECT 1 WHERE EXISTS (
      SELECT * FROM file 
      WHERE path = '/etc/motd' 
      AND uid = 0 
      AND gid = 0 
      AND mode = '0644'
    ) OR NOT EXISTS (
      SELECT * FROM file WHERE path = '/etc/motd'
    );
  purpose: Informational
  tags: compliance, CIS, CIS_Level1, CIS-ubuntu-24.04-1.6.1
  contributors: allenhouchins

---
apiVersion: v1
kind: policy
spec:
  name: CIS - permissions on /etc/issue are configured
  platforms: Linux
  platform: linux
  description: |
    The contents of the /etc/issue file are displayed to users prior to login for local terminals.
  resolution: |
    Run the following commands:
    # chown root:root /etc/issue
    # chmod 644 /etc/issue
  query: |
    SELECT 1 WHERE EXISTS (
      SELECT * FROM file 
      WHERE path = '/etc/issue' 
      AND uid = 0 
      AND gid = 0 
      AND mode = '0644'
    );
  purpose: Informational
  tags: compliance, CIS, CIS_Level1, CIS-ubuntu-24.04-1.6.2
  contributors: allenhouchins

---
apiVersion: v1
kind: policy
spec:
  name: CIS - permissions on /etc/issue.net are configured
  platforms: Linux
  platform: linux
  description: |
    The contents of the /etc/issue.net file are displayed to users prior to login for remote connections from configured services.
  resolution: |
    Run the following commands:
    # chown root:root /etc/issue.net
    # chmod 644 /etc/issue.net
  query: |
    SELECT 1 WHERE EXISTS (
      SELECT * FROM file 
      WHERE path = '/etc/issue.net' 
      AND uid = 0 
      AND gid = 0 
      AND mode = '0644'
    );
  purpose: Informational
  tags: compliance, CIS, CIS_Level1, CIS-ubuntu-24.04-1.6.3
  contributors: allenhouchins

---
apiVersion: v1
kind: policy
spec:
  name: CIS - GNOME Display Manager is removed
  platforms: Linux
  platform: linux
  description: |
    The GNOME Display Manager (GDM) is a program that manages graphical display servers.
  resolution: |
    Remove the gdm3 package:
    # apt purge gdm3
  query: |
    SELECT 1 WHERE NOT EXISTS (
      SELECT * FROM deb_packages WHERE name = 'gdm3' AND status = 'install ok installed'
    );
  purpose: Informational
  tags: compliance, CIS, CIS_Level1_Server, CIS-ubuntu-24.04-1.7.1, server_only
  contributors: allenhouchins

# =============================================================================
# SECTION 2: SERVICES - TIME SYNCHRONIZATION
# =============================================================================

---
apiVersion: v1
kind: policy
spec:
  name: CIS - time synchronization is in use
  platforms: Linux
  platform: linux
  description: |
    System time should be synchronized between all systems in an environment.
  resolution: |
    Install and configure chrony:
    # apt install chrony
  query: |
    SELECT 1 WHERE EXISTS (
      SELECT * FROM deb_packages 
      WHERE (name = 'chrony' OR name = 'systemd-timesyncd') 
      AND status = 'install ok installed'
    );
  purpose: Informational
  tags: compliance, CIS, CIS_Level1, CIS-ubuntu-24.04-2.1.1.1
  contributors: allenhouchins

---
apiVersion: v1
kind: policy
spec:
  name: CIS - single time synchronization daemon is in use
  platforms: Linux
  platform: linux
  description: |
    Multiple time synchronization methods should not be in use on the same system.
  resolution: |
    Select one time synchronization method and remove the others.
  query: |
    SELECT 1 WHERE (
      SELECT COUNT(*) FROM deb_packages 
      WHERE name IN ('chrony', 'ntp', 'systemd-timesyncd') 
      AND status = 'install ok installed'
    ) <= 1;
  purpose: Informational
  tags: compliance, CIS, CIS_Level1, CIS-ubuntu-24.04-2.1.1.2
  contributors: allenhouchins

---
apiVersion: v1
kind: policy
spec:
  name: CIS - chrony is running as user _chrony
  platforms: Linux
  platform: linux
  description: |
    The chrony daemon should be configured to run as the _chrony user.
  resolution: |
    Edit /etc/chrony/chrony.conf and add or edit the user line:
    user _chrony
  query: |
    SELECT 1 WHERE EXISTS (
      SELECT 1 FROM processes p 
      JOIN users u ON p.uid = u.uid
      WHERE p.name = 'chronyd' 
      AND u.username = '_chrony'
    ) OR NOT EXISTS (
      SELECT 1 FROM processes WHERE name = 'chronyd'
    );
  purpose: Informational
  tags: compliance, CIS, CIS_Level1, CIS-ubuntu-24.04-2.1.2.2
  contributors: allenhouchins

# =============================================================================
# SECTION 2: SERVICES - SPECIAL PURPOSE SERVICES
# =============================================================================

---
apiVersion: v1
kind: policy
spec:
  name: CIS - X Window system is not installed
  platforms: Linux
  platform: linux
  description: |
    The X Window System provides a Graphical User Interface (GUI) where users can have multiple windows.
  resolution: |
    Remove the X Windows System packages:
    # apt purge xserver-xorg*
  query: |
    SELECT 1 WHERE NOT EXISTS (
      SELECT * FROM deb_packages WHERE name LIKE 'xserver-xorg%' AND status = 'install ok installed'
    );
  purpose: Informational
  tags: compliance, CIS, CIS_Level1_Server, CIS-ubuntu-24.04-2.2.1, server_only
  contributors: allenhouchins

---
apiVersion: v1
kind: policy
spec:
  name: CIS - Avahi Server is not installed
  platforms: Linux
  platform: linux
  description: |
    Avahi is a free zeroconf implementation, including a system for multicast DNS/DNS-SD service discovery.
  resolution: |
    Remove avahi-daemon:
    # apt purge avahi-daemon
  query: |
    SELECT 1 WHERE NOT EXISTS (
      SELECT * FROM deb_packages WHERE name = 'avahi-daemon' AND status = 'install ok installed'
    );
  purpose: Informational
  tags: compliance, CIS, CIS_Level1, CIS-ubuntu-24.04-2.2.2
  contributors: allenhouchins

---
apiVersion: v1
kind: policy
spec:
  name: CIS - CUPS is not installed
  platforms: Linux
  platform: linux
  description: |
    The Common Unix Print System (CUPS) provides the ability to print to both local and network printers.
  resolution: |
    Remove CUPS:
    # apt purge cups
  query: |
    SELECT 1 WHERE NOT EXISTS (
      SELECT * FROM deb_packages WHERE name = 'cups' AND status = 'install ok installed'
    );
  purpose: Informational
  tags: compliance, CIS, CIS_Level1, CIS-ubuntu-24.04-2.2.3
  contributors: allenhouchins

---
apiVersion: v1
kind: policy
spec:
  name: CIS - DHCP Server is not installed
  platforms: Linux
  platform: linux
  description: |
    The Dynamic Host Configuration Protocol (DHCP) is a service that allows machines to be dynamically assigned IP addresses.
  resolution: |
    Remove the DHCP server:
    # apt purge isc-dhcp-server
  query: |
    SELECT 1 WHERE NOT EXISTS (
      SELECT * FROM deb_packages WHERE name = 'isc-dhcp-server' AND status = 'install ok installed'
    );
  purpose: Informational
  tags: compliance, CIS, CIS_Level1, CIS-ubuntu-24.04-2.2.4
  contributors: allenhouchins

---
apiVersion: v1
kind: policy
spec:
  name: CIS - LDAP server is not installed
  platforms: Linux
  platform: linux
  description: |
    The Lightweight Directory Access Protocol (LDAP) was introduced as a replacement for NIS/YP.
  resolution: |
    Remove the LDAP server:
    # apt purge slapd
  query: |
    SELECT 1 WHERE NOT EXISTS (
      SELECT * FROM deb_packages WHERE name = 'slapd' AND status = 'install ok installed'
    );
  purpose: Informational
  tags: compliance, CIS, CIS_Level1, CIS-ubuntu-24.04-2.2.5
  contributors: allenhouchins

---
apiVersion: v1
kind: policy
spec:
  name: CIS - NFS is not installed
  platforms: Linux
  platform: linux
  description: |
    The Network File System (NFS) is one of the first and most widely distributed file systems in the UNIX environment.
  resolution: |
    Remove NFS:
    # apt purge nfs-kernel-server
  query: |
    SELECT 1 WHERE NOT EXISTS (
      SELECT * FROM deb_packages WHERE name = 'nfs-kernel-server' AND status = 'install ok installed'
    );
  purpose: Informational
  tags: compliance, CIS, CIS_Level1, CIS-ubuntu-24.04-2.2.6
  contributors: allenhouchins

---
apiVersion: v1
kind: policy
spec:
  name: CIS - DNS Server is not installed
  platforms: Linux
  platform: linux
  description: |
    The Domain Name System (DNS) is a hierarchical naming system that maps names to IP addresses for computers connected to a network.
  resolution: |
    Remove BIND DNS server:
    # apt purge bind9
  query: |
    SELECT 1 WHERE NOT EXISTS (
      SELECT * FROM deb_packages WHERE name = 'bind9' AND status = 'install ok installed'
    );
  purpose: Informational
  tags: compliance, CIS, CIS_Level1, CIS-ubuntu-24.04-2.2.7
  contributors: allenhouchins

---
apiVersion: v1
kind: policy
spec:
  name: CIS - FTP Server is not installed
  platforms: Linux
  platform: linux
  description: |
    The File Transfer Protocol (FTP) provides networked computers with the ability to transfer files.
  resolution: |
    Remove vsftpd:
    # apt purge vsftpd
  query: |
    SELECT 1 WHERE NOT EXISTS (
      SELECT * FROM deb_packages WHERE name = 'vsftpd' AND status = 'install ok installed'
    );
  purpose: Informational
  tags: compliance, CIS, CIS_Level1, CIS-ubuntu-24.04-2.2.8
  contributors: allenhouchins

---
apiVersion: v1
kind: policy
spec:
  name: CIS - HTTP server is not installed
  platforms: Linux
  platform: linux
  description: |
    HTTP or web servers provide the ability to host web site content.
  resolution: |
    Remove the web server packages:
    # apt purge apache2 nginx
  query: |
    SELECT 1 WHERE NOT EXISTS (
      SELECT * FROM deb_packages WHERE (name = 'apache2' OR name = 'nginx') AND status = 'install ok installed'
    );
  purpose: Informational
  tags: compliance, CIS, CIS_Level1, CIS-ubuntu-24.04-2.2.9
  contributors: allenhouchins

---
apiVersion: v1
kind: policy
spec:
  name: CIS - IMAP and POP3 server are not installed
  platforms: Linux
  platform: linux
  description: |
    dovecot-imapd and dovecot-pop3d are an open source IMAP and POP3 server for Linux based systems.
  resolution: |
    Remove dovecot:
    # apt purge dovecot-imapd dovecot-pop3d
  query: |
    SELECT 1 WHERE NOT EXISTS (
      SELECT * FROM deb_packages WHERE (name = 'dovecot-imapd' OR name = 'dovecot-pop3d') AND status = 'install ok installed'
    );
  purpose: Informational
  tags: compliance, CIS, CIS_Level1, CIS-ubuntu-24.04-2.2.10
  contributors: allenhouchins

---
apiVersion: v1
kind: policy
spec:
  name: CIS - Samba is not installed
  platforms: Linux
  platform: linux
  description: |
    The Samba daemon allows system administrators to configure their Linux systems to share file systems and directories with Windows desktops.
  resolution: |
    Remove Samba:
    # apt purge samba
  query: |
    SELECT 1 WHERE NOT EXISTS (
      SELECT * FROM deb_packages WHERE name = 'samba' AND status = 'install ok installed'
    );
  purpose: Informational
  tags: compliance, CIS, CIS_Level1, CIS-ubuntu-24.04-2.2.11
  contributors: allenhouchins

---
apiVersion: v1
kind: policy
spec:
  name: CIS - HTTP Proxy Server is not installed
  platforms: Linux
  platform: linux
  description: |
    Squid is a standard proxy server used in many distributions and environments.
  resolution: |
    Remove squid:
    # apt purge squid
  query: |
    SELECT 1 WHERE NOT EXISTS (
      SELECT * FROM deb_packages WHERE name = 'squid' AND status = 'install ok installed'
    );
  purpose: Informational
  tags: compliance, CIS, CIS_Level1, CIS-ubuntu-24.04-2.2.12
  contributors: allenhouchins

---
apiVersion: v1
kind: policy
spec:
  name: CIS - SNMP Server is not installed
  platforms: Linux
  platform: linux
  description: |
    Simple Network Management Protocol (SNMP) is a widely used protocol for monitoring the health and welfare of network equipment.
  resolution: |
    Remove snmpd:
    # apt purge snmpd
  query: |
    SELECT 1 WHERE NOT EXISTS (
      SELECT * FROM deb_packages WHERE name = 'snmpd' AND status = 'install ok installed'
    );
  purpose: Informational
  tags: compliance, CIS, CIS_Level1, CIS-ubuntu-24.04-2.2.13
  contributors: allenhouchins

---
apiVersion: v1
kind: policy
spec:
  name: CIS - NIS Server is not installed
  platforms: Linux
  platform: linux
  description: |
    The Network Information Service (NIS) provides a simple network lookup service consisting of databases and processes.
  resolution: |
    Remove nis:
    # apt purge nis
  query: |
    SELECT 1 WHERE NOT EXISTS (
      SELECT * FROM deb_packages WHERE name = 'nis' AND status = 'install ok installed'
    );
  purpose: Informational
  tags: compliance, CIS, CIS_Level1, CIS-ubuntu-24.04-2.2.15
  contributors: allenhouchins

---
apiVersion: v1
kind: policy
spec:
  name: CIS - rsync service is either not installed or masked
  platforms: Linux
  platform: linux
  description: |
    The rsync service can be used to synchronize files between systems over network connections.
  resolution: |
    Run the following commands to mask rsync:
    # systemctl mask rsync
  query: |
    SELECT 1 WHERE NOT EXISTS (
      SELECT * FROM systemd_units 
      WHERE id = 'rsync.service' 
      AND active_state = 'active'
    );
  purpose: Informational
  tags: compliance, CIS, CIS_Level1, CIS-ubuntu-24.04-2.2.16
  contributors: allenhouchins

# =============================================================================
# SECTION 2: SERVICES - CLIENT SERVICES
# =============================================================================

---
apiVersion: v1
kind: policy
spec:
  name: CIS - NIS Client is not installed
  platforms: Linux
  platform: linux
  description: |
    The Network Information Service (NIS), formerly known as Yellow Pages, is a client-server directory service protocol used to distribute system configuration files.
  resolution: |
    Remove nis:
    # apt purge nis
  query: |
    SELECT 1 WHERE NOT EXISTS (
      SELECT * FROM deb_packages WHERE name = 'nis' AND status = 'install ok installed'
    );
  purpose: Informational
  tags: compliance, CIS, CIS_Level1, CIS-ubuntu-24.04-2.3.1
  contributors: allenhouchins

---
apiVersion: v1
kind: policy
spec:
  name: CIS - rsh client is not installed
  platforms: Linux
  platform: linux
  description: |
    The rsh package contains the client commands for the rsh services.
  resolution: |
    Remove rsh:
    # apt purge rsh-client
  query: |
    SELECT 1 WHERE NOT EXISTS (
      SELECT * FROM deb_packages WHERE name = 'rsh-client' AND status = 'install ok installed'
    );
  purpose: Informational
  tags: compliance, CIS, CIS_Level1, CIS-ubuntu-24.04-2.3.2
  contributors: allenhouchins

---
apiVersion: v1
kind: policy
spec:
  name: CIS - talk client is not installed
  platforms: Linux
  platform: linux
  description: |
    The talk software makes it possible for users to send and receive messages across the network to another user.
  resolution: |
    Remove talk:
    # apt purge talk
  query: |
    SELECT 1 WHERE NOT EXISTS (
      SELECT * FROM deb_packages WHERE name = 'talk' AND status = 'install ok installed'
    );
  purpose: Informational
  tags: compliance, CIS, CIS_Level1, CIS-ubuntu-24.04-2.3.3
  contributors: allenhouchins

---
apiVersion: v1
kind: policy
spec:
  name: CIS - telnet client is not installed
  platforms: Linux
  platform: linux
  description: |
    The telnet package contains the telnet client, which allows users to start connections to other systems via the telnet protocol.
  resolution: |
    Remove telnet:
    # apt purge telnet
  query: |
    SELECT 1 WHERE NOT EXISTS (
      SELECT * FROM deb_packages WHERE name = 'telnet' AND status = 'install ok installed'
    );
  purpose: Informational
  tags: compliance, CIS, CIS_Level1, CIS-ubuntu-24.04-2.3.4
  contributors: allenhouchins

---
apiVersion: v1
kind: policy
spec:
  name: CIS - LDAP client is not installed
  platforms: Linux
  platform: linux
  description: |
    The Lightweight Directory Access Protocol (LDAP) was introduced as a replacement for NIS/YP.
  resolution: |
    Remove ldap-utils:
    # apt purge ldap-utils
  query: |
    SELECT 1 WHERE NOT EXISTS (
      SELECT * FROM deb_packages WHERE name = 'ldap-utils' AND status = 'install ok installed'
    );
  purpose: Informational
  tags: compliance, CIS, CIS_Level1, CIS-ubuntu-24.04-2.3.5
  contributors: allenhouchins

---
apiVersion: v1
kind: policy
spec:
  name: CIS - RPC is not installed
  platforms: Linux
  platform: linux
  description: |
    Remote Procedure Call (RPC) is a method for creating low level client server applications across a network.
  resolution: |
    Remove rpcbind:
    # apt purge rpcbind
  query: |
    SELECT 1 WHERE NOT EXISTS (
      SELECT * FROM deb_packages WHERE name = 'rpcbind' AND status = 'install ok installed'
    );
  purpose: Informational
  tags: compliance, CIS, CIS_Level1, CIS-ubuntu-24.04-2.3.6
  contributors: allenhouchins

# =============================================================================
# SECTION 3: NETWORK CONFIGURATION
# =============================================================================

---
apiVersion: v1
kind: policy
spec:
  name: CIS - IP forwarding is disabled
  platforms: Linux
  platform: linux
  description: |
    The net.ipv4.ip_forward and net.ipv6.conf.all.forwarding flags are used to tell the system whether it can forward packets or not.
  resolution: |
    Set the following parameters in /etc/sysctl.conf or a /etc/sysctl.d/* file:
    net.ipv4.ip_forward = 0
    net.ipv6.conf.all.forwarding = 0
    Run: sysctl -w net.ipv4.ip_forward=0
    Run: sysctl -w net.ipv6.conf.all.forwarding=0
  query: |
    SELECT 1 WHERE EXISTS (
      SELECT * FROM system_controls 
      WHERE name = 'net.ipv4.ip_forward' 
      AND current_value = '0'
    );
  purpose: Informational
  tags: compliance, CIS, CIS_Level1, CIS-ubuntu-24.04-3.1.1
  contributors: allenhouchins

---
apiVersion: v1
kind: policy
spec:
  name: CIS - packet redirect sending is disabled
  platforms: Linux
  platform: linux
  description: |
    ICMP Redirects are used to send routing information to other hosts.
  resolution: |
    Set the following parameters in /etc/sysctl.conf or a /etc/sysctl.d/* file:
    net.ipv4.conf.all.send_redirects = 0
    net.ipv4.conf.default.send_redirects = 0
  query: |
    SELECT 1 WHERE EXISTS (
      SELECT * FROM system_controls 
      WHERE name = 'net.ipv4.conf.all.send_redirects' 
      AND current_value = '0'
    );
  purpose: Informational
  tags: compliance, CIS, CIS_Level1, CIS-ubuntu-24.04-3.1.2
  contributors: allenhouchins

---
apiVersion: v1
kind: policy
spec:
  name: CIS - source routed packets are not accepted
  platforms: Linux
  platform: linux
  description: |
    In networking, source routing allows a sender to partially or fully specify the route packets take through a network.
  resolution: |
    Set the following parameters in /etc/sysctl.conf or a /etc/sysctl.d/* file:
    net.ipv4.conf.all.accept_source_route = 0
    net.ipv4.conf.default.accept_source_route = 0
    net.ipv6.conf.all.accept_source_route = 0
    net.ipv6.conf.default.accept_source_route = 0
  query: |
    SELECT 1 WHERE EXISTS (
      SELECT * FROM system_controls 
      WHERE name = 'net.ipv4.conf.all.accept_source_route' 
      AND current_value = '0'
    );
  purpose: Informational
  tags: compliance, CIS, CIS_Level1, CIS-ubuntu-24.04-3.1.3
  contributors: allenhouchins

---
apiVersion: v1
kind: policy
spec:
  name: CIS - ICMP redirects are not accepted
  platforms: Linux
  platform: linux
  description: |
    ICMP redirect messages are packets that convey routing information and tell your host to send packets via an alternate path.
  resolution: |
    Set the following parameters in /etc/sysctl.conf or a /etc/sysctl.d/* file:
    net.ipv4.conf.all.accept_redirects = 0
    net.ipv4.conf.default.accept_redirects = 0
    net.ipv6.conf.all.accept_redirects = 0
    net.ipv6.conf.default.accept_redirects = 0
  query: |
    SELECT 1 WHERE EXISTS (
      SELECT * FROM system_controls 
      WHERE name = 'net.ipv4.conf.all.accept_redirects' 
      AND current_value = '0'
    );
  purpose: Informational
  tags: compliance, CIS, CIS_Level1, CIS-ubuntu-24.04-3.1.4
  contributors: allenhouchins

---
apiVersion: v1
kind: policy
spec:
  name: CIS - secure ICMP redirects are not accepted
  platforms: Linux
  platform: linux
  description: |
    Secure ICMP redirects are the same as ICMP redirects, except they come from gateways listed on the default gateway list.
  resolution: |
    Set the following parameters in /etc/sysctl.conf or a /etc/sysctl.d/* file:
    net.ipv4.conf.all.secure_redirects = 0
    net.ipv4.conf.default.secure_redirects = 0
  query: |
    SELECT 1 WHERE EXISTS (
      SELECT * FROM system_controls 
      WHERE name = 'net.ipv4.conf.all.secure_redirects' 
      AND current_value = '0'
    );
  purpose: Informational
  tags: compliance, CIS, CIS_Level1, CIS-ubuntu-24.04-3.1.5
  contributors: allenhouchins

---
apiVersion: v1
kind: policy
spec:
  name: CIS - suspicious packets are logged
  platforms: Linux
  platform: linux
  description: |
    When enabled, this feature logs packets with un-routable source addresses to the kernel log.
  resolution: |
    Set the following parameters in /etc/sysctl.conf or a /etc/sysctl.d/* file:
    net.ipv4.conf.all.log_martians = 1
    net.ipv4.conf.default.log_martians = 1
  query: |
    SELECT 1 WHERE EXISTS (
      SELECT * FROM system_controls 
      WHERE name = 'net.ipv4.conf.all.log_martians' 
      AND current_value = '1'
    );
  purpose: Informational
  tags: compliance, CIS, CIS_Level1, CIS-ubuntu-24.04-3.1.6
  contributors: allenhouchins

---
apiVersion: v1
kind: policy
spec:
  name: CIS - broadcast ICMP requests are ignored
  platforms: Linux
  platform: linux
  description: |
    Setting net.ipv4.icmp_echo_ignore_broadcasts to 1 will cause the system to ignore all ICMP echo and timestamp requests to broadcast and multicast addresses.
  resolution: |
    Set the following parameter in /etc/sysctl.conf or a /etc/sysctl.d/* file:
    net.ipv4.icmp_echo_ignore_broadcasts = 1
  query: |
    SELECT 1 WHERE EXISTS (
      SELECT * FROM system_controls 
      WHERE name = 'net.ipv4.icmp_echo_ignore_broadcasts' 
      AND current_value = '1'
    );
  purpose: Informational
  tags: compliance, CIS, CIS_Level1, CIS-ubuntu-24.04-3.1.7
  contributors: allenhouchins

---
apiVersion: v1
kind: policy
spec:
  name: CIS - bogus ICMP responses are ignored
  platforms: Linux
  platform: linux
  description: |
    Setting icmp_ignore_bogus_error_responses to 1 prevents the kernel from logging bogus responses.
  resolution: |
    Set the following parameter in /etc/sysctl.conf or a /etc/sysctl.d/* file:
    net.ipv4.icmp_ignore_bogus_error_responses = 1
  query: |
    SELECT 1 WHERE EXISTS (
      SELECT * FROM system_controls 
      WHERE name = 'net.ipv4.icmp_ignore_bogus_error_responses' 
      AND current_value = '1'
    );
  purpose: Informational
  tags: compliance, CIS, CIS_Level1, CIS-ubuntu-24.04-3.1.8
  contributors: allenhouchins

---
apiVersion: v1
kind: policy
spec:
  name: CIS - Reverse Path Filtering is enabled
  platforms: Linux
  platform: linux
  description: |
    Setting net.ipv4.conf.all.rp_filter and net.ipv4.conf.default.rp_filter to 1 forces the Linux kernel to utilize reverse path filtering.
  resolution: |
    Set the following parameters in /etc/sysctl.conf or a /etc/sysctl.d/* file:
    net.ipv4.conf.all.rp_filter = 1
    net.ipv4.conf.default.rp_filter = 1
  query: |
    SELECT 1 WHERE EXISTS (
      SELECT * FROM system_controls 
      WHERE name = 'net.ipv4.conf.all.rp_filter' 
      AND current_value = '1'
    );
  purpose: Informational
  tags: compliance, CIS, CIS_Level1, CIS-ubuntu-24.04-3.1.9
  contributors: allenhouchins

---
apiVersion: v1
kind: policy
spec:
  name: CIS - TCP SYN cookies is enabled
  platforms: Linux
  platform: linux
  description: |
    When tcp_syncookies is set, the kernel will handle TCP SYN packets normally until the half-open connection queue is full.
  resolution: |
    Set the following parameter in /etc/sysctl.conf or a /etc/sysctl.d/* file:
    net.ipv4.tcp_syncookies = 1
  query: |
    SELECT 1 WHERE EXISTS (
      SELECT * FROM system_controls 
      WHERE name = 'net.ipv4.tcp_syncookies' 
      AND current_value = '1'
    );
  purpose: Informational
  tags: compliance, CIS, CIS_Level1, CIS-ubuntu-24.04-3.1.10
  contributors: allenhouchins

---
apiVersion: v1
kind: policy
spec:
  name: CIS - IPv6 router advertisements are not accepted
  platforms: Linux
  platform: linux
  description: |
    This setting disables the system's ability to accept IPv6 router advertisements.
  resolution: |
    Set the following parameters in /etc/sysctl.conf or a /etc/sysctl.d/* file:
    net.ipv6.conf.all.accept_ra = 0
    net.ipv6.conf.default.accept_ra = 0
  query: |
    SELECT 1 WHERE EXISTS (
      SELECT * FROM system_controls 
      WHERE name = 'net.ipv6.conf.all.accept_ra' 
      AND current_value = '0'
    );
  purpose: Informational
  tags: compliance, CIS, CIS_Level1, CIS-ubuntu-24.04-3.1.11
  contributors: allenhouchins

# =============================================================================
# SECTION 3: NETWORK CONFIGURATION - FIREWALL
# =============================================================================

---
apiVersion: v1
kind: policy
spec:
  name: CIS - ufw is installed
  platforms: Linux
  platform: linux
  description: |
    The Uncomplicated Firewall (ufw) is a frontend for iptables and is designed to make configuring a firewall easier.
  resolution: |
    Install ufw:
    # apt install ufw
  query: |
    SELECT 1 WHERE EXISTS (
      SELECT * FROM deb_packages WHERE name = 'ufw' AND status = 'install ok installed'
    );
  purpose: Informational
  tags: compliance, CIS, CIS_Level1, CIS-ubuntu-24.04-3.2.1.1
  contributors: allenhouchins

---
apiVersion: v1
kind: policy
spec:
  name: CIS - iptables-persistent is not installed with ufw
  platforms: Linux
  platform: linux
  description: |
    The iptables-persistent package saves the iptables rules for IPv4 and IPv6 to files.
  resolution: |
    Remove iptables-persistent:
    # apt purge iptables-persistent
  query: |
    SELECT 1 WHERE NOT EXISTS (
      SELECT * FROM deb_packages 
      WHERE name = 'iptables-persistent' 
      AND status = 'install ok installed'
    ) OR NOT EXISTS (
      SELECT * FROM deb_packages 
      WHERE name = 'ufw' 
      AND status = 'install ok installed'
    );
  purpose: Informational
  tags: compliance, CIS, CIS_Level1, CIS-ubuntu-24.04-3.2.1.2
  contributors: allenhouchins

---
apiVersion: v1
kind: policy
spec:
  name: CIS - ufw service is enabled
  platforms: Linux
  platform: linux
  description: |
    When a firewall is enabled, it will ensure that only connections to allowed services are accepted.
  resolution: |
    Run the following command to enable ufw:
    # ufw enable
  query: |
    SELECT 1 WHERE EXISTS (
      SELECT * FROM systemd_units 
      WHERE id = 'ufw.service' 
      AND active_state = 'active'
      AND unit_file_state = 'enabled'
    );
  purpose: Informational
  tags: compliance, CIS, CIS_Level1, CIS-ubuntu-24.04-3.2.1.3
  contributors: allenhouchins

---
apiVersion: v1
kind: policy
spec:
  name: CIS - nftables loopback traffic is configured
  platforms: Linux
  platform: linux
  description: |
    Configure the loopback interface to accept traffic. Configure all other interfaces to deny traffic to the loopback network.
  resolution: |
    Run the following commands to create the table and chains if they don't exist:
    # nft create table inet filter
    # nft create chain inet filter input { type filter hook input priority 0 \; }
    # nft create chain inet filter output { type filter hook output priority 0 \; }
    
    Then add the loopback rules:
    # nft add rule inet filter input iif lo accept
    # nft add rule inet filter output oif lo accept
    # nft add rule inet filter input ip saddr 127.0.0.0/8 counter drop
    # nft add rule inet filter input ip6 saddr ::1 counter drop
    
    To make rules persistent, save them:
    # nft list ruleset > /etc/nftables.conf
    # systemctl enable nftables
  query: |
    WITH loopback_accept AS (
      -- Find rules that accept loopback traffic
      SELECT DISTINCT 
        SUBSTR(fullkey, 1, INSTR(fullkey || '/expr', '/expr') - 1) as rule_base
      FROM nftables 
      WHERE value IN ('lo', '"lo"')
    ),
    loopback_drop AS (
      -- Find rules that drop 127.0.0.0/8 traffic
      SELECT DISTINCT 
        SUBSTR(fullkey, 1, INSTR(fullkey || '/expr', '/expr') - 1) as rule_base
      FROM nftables 
      WHERE (value = '127.0.0.0' AND fullkey LIKE '%/prefix/addr')
         OR (value = '8' AND fullkey LIKE '%/prefix/len')
    )
    SELECT 1 WHERE EXISTS (
      SELECT 1 FROM loopback_accept
    ) AND EXISTS (
      SELECT 1 FROM loopback_drop
    );
  purpose: Informational
  tags: compliance, CIS, CIS_Level1, CIS-ubuntu-24.04-3.2.1.4
  contributors: allenhouchins

# =============================================================================
# SECTION 4: LOGGING AND AUDITING - RSYSLOG
# =============================================================================

---
apiVersion: v1
kind: policy
spec:
  name: CIS - rsyslog is installed
  platforms: Linux
  platform: linux
  description: |
    The rsyslog software is a recommended replacement to the original syslogd daemon.
  resolution: |
    Install rsyslog:
    # apt install rsyslog
  query: |
    SELECT 1 WHERE EXISTS (
      SELECT * FROM deb_packages WHERE name = 'rsyslog' AND status = 'install ok installed'
    );
  purpose: Informational
  tags: compliance, CIS, CIS_Level1, CIS-ubuntu-24.04-4.1.1.1
  contributors: allenhouchins

---
apiVersion: v1
kind: policy
spec:
  name: CIS - rsyslog service is enabled
  platforms: Linux
  platform: linux
  description: |
    If the rsyslog service is not activated the system may lack logging.
  resolution: |
    Run the following command to enable rsyslog:
    # systemctl --now enable rsyslog
  query: |
    SELECT 1 WHERE EXISTS (
      SELECT * FROM systemd_units WHERE id = 'rsyslog.service' AND active_state = 'active'
    );
  purpose: Informational
  tags: compliance, CIS, CIS_Level1, CIS-ubuntu-24.04-4.1.1.2
  contributors: allenhouchins

---
apiVersion: v1
kind: policy
spec:
  name: CIS - rsyslog default file permissions are configured
  platforms: Linux
  platform: linux
  description: |
    rsyslog will create logfiles that may contain sensitive information.
  resolution: |
    Edit /etc/rsyslog.conf and /etc/rsyslog.d/*.conf files and set:
    $FileCreateMode 0640
  query: |
    SELECT 1 WHERE EXISTS (
      SELECT * FROM file WHERE path = '/etc/rsyslog.conf'
    );
  purpose: Informational
  tags: compliance, CIS, CIS_Level1, CIS-ubuntu-24.04-4.1.1.3
  contributors: allenhouchins

---
apiVersion: v1
kind: policy
spec:
  name: CIS - logging is configured
  platforms: Linux
  platform: linux
  description: |
    The /etc/rsyslog.conf and /etc/rsyslog.d/*.conf files specify rules for logging and which files are to be used to log certain classes of messages.
  resolution: |
    Edit /etc/rsyslog.conf and /etc/rsyslog.d/*.conf files and configure logging as appropriate for your environment.
  query: |
    SELECT 1 WHERE EXISTS (
      SELECT * FROM file WHERE path = '/etc/rsyslog.conf' AND size > 0
    );
  purpose: Informational
  tags: compliance, CIS, CIS_Level1, CIS-ubuntu-24.04-4.1.1.4
  contributors: allenhouchins

---
apiVersion: v1
kind: policy
spec:
  name: CIS - rsyslog is configured to send logs to a remote log host
  platforms: Linux
  platform: linux
  description: |
    The rsyslog utility supports the ability to send logs it gathers to a remote log host.
  resolution: |
    Edit /etc/rsyslog.conf and /etc/rsyslog.d/*.conf files and add:
    *.* @@<remote_log_server>
  query: |
    SELECT 1 WHERE EXISTS (
      SELECT * FROM file WHERE path = '/etc/rsyslog.conf'
    );
  purpose: Informational
  tags: compliance, CIS, CIS_Level1, CIS-ubuntu-24.04-4.1.1.5
  contributors: allenhouchins

# =============================================================================
# SECTION 4: LOGGING AND AUDITING - CONFIGURE JOURNALD
# =============================================================================

---
apiVersion: v1
kind: policy
spec:
  name: CIS - systemd-journal-remote is installed
  platforms: Linux
  platform: linux
  description: |
    Journald supports the ability to securely send log messages to a remote log aggregation server.
  resolution: |
    Install systemd-journal-remote:
    # apt install systemd-journal-remote
  query: |
    SELECT 1 WHERE EXISTS (
      SELECT * FROM deb_packages WHERE name = 'systemd-journal-remote' AND status = 'install ok installed'
    );
  purpose: Informational
  tags: compliance, CIS, CIS_Level1, CIS-ubuntu-24.04-4.3.1.1
  contributors: allenhouchins

---
apiVersion: v1
kind: policy
spec:
  name: CIS - systemd-journald service is enabled
  platforms: Linux
  platform: linux
  description: |
    By default the systemd-journald service stores log data in a ring buffer.
  resolution: |
    No action required. This is the default behavior.
  query: |
    SELECT 1 WHERE EXISTS (
      SELECT * FROM systemd_units WHERE id = 'systemd-journald.service' AND active_state = 'active'
    );
  purpose: Informational
  tags: compliance, CIS, CIS_Level1, CIS-ubuntu-24.04-4.3.1.2
  contributors: allenhouchins

---
apiVersion: v1
kind: policy
spec:
  name: CIS - journald ForwardToSyslog is disabled
  platforms: Linux
  platform: linux
  description: |
    Data from journald should be forwarded to a remote log aggregation server.
  resolution: |
    Edit the /etc/systemd/journald.conf file and ensure ForwardToSyslog is set to no
  query: |
    SELECT 1 WHERE NOT EXISTS (
      SELECT * FROM augeas 
      WHERE path = '/etc/systemd/journald.conf/Journal/ForwardToSyslog'
      AND label = 'ForwardToSyslog'
      AND value != 'no'
    );
  purpose: Informational
  tags: compliance, CIS, CIS_Level1, CIS-ubuntu-24.04-4.3.1.3
  contributors: allenhouchins

---
apiVersion: v1
kind: policy
spec:
  name: CIS - journald Storage is configured
  platforms: Linux
  platform: linux
  description: |
    Journald should be configured to store logs persistently.
  resolution: |
    Edit the /etc/systemd/journald.conf file and set the following parameter:
    # SystemMaxUse=
    # SystemKeepFree=
    # SystemMaxFileSize=
    # RuntimeMaxUse=
    # RuntimeKeepFree=
    # RuntimeMaxFileSize=
  query: |
    SELECT 1 WHERE NOT EXISTS (
      SELECT * FROM listening_ports 
      WHERE port = 19532 AND protocol = 6
    );
  purpose: Informational
  tags: compliance, CIS, CIS_Level1, CIS-ubuntu-24.04-4.3.1.4
  contributors: allenhouchins

# =============================================================================
# SECTION 4: LOGGING AND AUDITING - CONFIGURE SYSTEM AUDITING
# =============================================================================

---
apiVersion: v1
kind: policy
spec:
  name: CIS - auditd is installed
  platforms: Linux
  platform: linux
  description: |
    auditd is the userspace component to the Linux Auditing System.
  resolution: |
    Install auditd:
    # apt install auditd audispd-plugins
  query: |
    SELECT 1 WHERE EXISTS (
      SELECT * FROM deb_packages WHERE name = 'auditd' AND status = 'install ok installed'
    );
  purpose: Informational
  tags: compliance, CIS, CIS_Level2, CIS-ubuntu-24.04-6.1.1.1
  contributors: allenhouchins

---
apiVersion: v1
kind: policy
spec:
  name: CIS - auditd service is enabled
  platforms: Linux
  platform: linux
  description: |
    The capturing of system events provides system administrators with information to allow them to determine if unauthorized access to their system is occurring.
  resolution: |
    Run the following command to enable auditd:
    # systemctl --now enable auditd
  query: |
    SELECT 1 WHERE EXISTS (
      SELECT * FROM systemd_units WHERE id = 'auditd.service' AND active_state = 'active'
    );
  purpose: Informational
  tags: compliance, CIS, CIS_Level2, CIS-ubuntu-24.04-6.1.1.2
  contributors: allenhouchins

---
apiVersion: v1
kind: policy
spec:
  name: CIS - auditing for processes that start prior to auditd is enabled
  platforms: Linux
  platform: linux
  description: |
    Configure grub so that processes that are capable of being audited can be audited even if they start up prior to auditd startup.
  resolution: |
    Edit /etc/default/grub and add the following parameter to GRUB_CMDLINE_LINUX:
    audit=1
    Run: update-grub
  query: |
    SELECT 1 WHERE EXISTS (
      SELECT * FROM kernel_info 
      WHERE arguments LIKE '%audit=1%'
    );
  purpose: Informational
  tags: compliance, CIS, CIS_Level2, CIS-ubuntu-24.04-6.1.1.3
  contributors: allenhouchins

---
apiVersion: v1
kind: policy
spec:
  name: CIS - audit_backlog_limit is sufficient
  platforms: Linux
  platform: linux
  description: |
    The backlog limit has a default setting of 64. This may not be sufficient for all environments.
  resolution: |
    Edit /etc/default/grub and add the following parameter to GRUB_CMDLINE_LINUX:
    audit_backlog_limit=8192
    Run: update-grub
  query: |
    -- Check for audit_backlog_limit parameter set to 8192 or higher
    -- Using kernel_info.arguments which contains boot parameters
    SELECT 1 WHERE EXISTS (
      SELECT * FROM kernel_info 
      WHERE arguments LIKE '%audit_backlog_limit=%'
      AND (
        -- Exact CIS recommended value
        arguments LIKE '%audit_backlog_limit=8192%' OR
        -- Common larger values that meet the requirement  
        arguments LIKE '%audit_backlog_limit=16384%' OR
        arguments LIKE '%audit_backlog_limit=32768%' OR
        arguments LIKE '%audit_backlog_limit=65536%' OR
        arguments LIKE '%audit_backlog_limit=131072%' OR
        arguments LIKE '%audit_backlog_limit=262144%' OR
        -- Values in 819x range (8193-8199)
        arguments LIKE '%audit_backlog_limit=8193%' OR
        arguments LIKE '%audit_backlog_limit=8194%' OR
        arguments LIKE '%audit_backlog_limit=8195%' OR
        arguments LIKE '%audit_backlog_limit=8196%' OR
        arguments LIKE '%audit_backlog_limit=8197%' OR
        arguments LIKE '%audit_backlog_limit=8198%' OR
        arguments LIKE '%audit_backlog_limit=8199%' OR
        -- Values starting with 82, 83, 84, etc. (all >= 8200)
        arguments LIKE '%audit_backlog_limit=82%' OR
        arguments LIKE '%audit_backlog_limit=83%' OR
        arguments LIKE '%audit_backlog_limit=84%' OR
        arguments LIKE '%audit_backlog_limit=85%' OR
        arguments LIKE '%audit_backlog_limit=86%' OR
        arguments LIKE '%audit_backlog_limit=87%' OR
        arguments LIKE '%audit_backlog_limit=88%' OR
        arguments LIKE '%audit_backlog_limit=89%' OR
        arguments LIKE '%audit_backlog_limit=9%'
      )
    );
  purpose: Informational
  tags: compliance, CIS, CIS_Level2, CIS-ubuntu-24.04-6.1.1.4
  contributors: allenhouchins
---
apiVersion: v1
kind: policy
spec:
  name: CIS - audit log storage size is configured
  platforms: Linux
  platform: linux
  description: |
    Configure the maximum size of the audit log file.
  resolution: |
    Set the following parameter in /etc/audit/auditd.conf:
    max_log_file = 100
  query: |
    SELECT 1 WHERE EXISTS (
      SELECT * FROM augeas 
      WHERE path = '/etc/audit/auditd.conf'
      AND label = 'max_log_file'
      AND CAST(value AS INTEGER) >= 100
    );
  purpose: Informational
  tags: compliance, CIS, CIS_Level2, CIS-ubuntu-24.04-6.1.2.1
  contributors: allenhouchins

---
apiVersion: v1
kind: policy
spec:
  name: CIS - audit logs are not automatically deleted
  platforms: Linux
  platform: linux
  description: |
    The max_log_file_action setting determines how to handle the audit log file reaching the max file size.
  resolution: |
    Set the following parameter in /etc/audit/auditd.conf:
    max_log_file_action = keep_logs
  query: |
    SELECT 1 WHERE EXISTS (
      SELECT * FROM augeas 
      WHERE path = '/etc/audit/auditd.conf' 
      AND label = 'max_log_file_action'
      AND value = 'keep_logs'
    );
  purpose: Informational
  tags: compliance, CIS, CIS_Level2, CIS-ubuntu-24.04-6.1.2.2
  contributors: allenhouchins

---
apiVersion: v1
kind: policy
spec:
  name: CIS - system is disabled when audit logs are full
  platforms: Linux
  platform: linux
  description: |
    The auditd daemon can be configured to halt the system when the audit logs are full.
  resolution: |
    Set the following parameters in /etc/audit/auditd.conf:
    space_left_action = email
    action_mail_acct = root
    admin_space_left_action = halt
  query: |
    SELECT 1 WHERE EXISTS (
      SELECT * FROM augeas 
      WHERE path = '/etc/audit/auditd.conf' 
      AND label = 'space_left_action'
      AND value = 'email'
    ) AND EXISTS (
      SELECT * FROM augeas 
      WHERE path = '/etc/audit/auditd.conf' 
      AND label = 'action_mail_acct'
      AND value = 'root'
    ) AND EXISTS (
      SELECT * FROM augeas 
      WHERE path = '/etc/audit/auditd.conf' 
      AND label = 'admin_space_left_action'
      AND value = 'halt'
    );
  purpose: Informational
  tags: compliance, CIS, CIS_Level2, CIS-ubuntu-24.04-6.1.2.3
  contributors: allenhouchins

---
apiVersion: v1
kind: policy
spec:
  name: CIS - all logfiles have appropriate permissions and ownership
  platforms: Linux
  platform: linux
  description: |
    System log files stored in /var/log/ should have appropriate permissions and ownership.
  resolution: |
    Run the following command to set permissions on all existing log files:
    # find /var/log -type f -exec chmod g-wx,o-rwx "{}" + -o -type d -exec chmod g-w,o-rwx "{}" +
  query: |
    SELECT 1 WHERE NOT EXISTS (
      SELECT * FROM file 
      WHERE path LIKE '/var/log/%' 
      AND type = 'regular' 
      AND (
        mode NOT LIKE '0640' 
        AND mode NOT LIKE '0600'
      )
    );
  purpose: Informational
  tags: compliance, CIS, CIS_Level1, CIS-ubuntu-24.04-6.1.3
  contributors: allenhouchins

# =============================================================================
# SECTION 4: LOGGING AND AUDITING - CONFIGURE AUDIT RULES
# =============================================================================

---
apiVersion: v1
kind: policy
spec:
  name: CIS - audit rule for apparmor parser is configured
  platforms: Linux
  platform: linux
  description: |
    Monitor usage of AppArmor mandatory access controls.
  resolution: |
    Add the following line to /etc/audit/rules.d/50-MAC-policy.rules:
    -w /usr/sbin/apparmor_parser -p x -k MAC-policy
  query: |
    SELECT 1 WHERE EXISTS (
      SELECT * FROM file 
      WHERE path LIKE '/etc/audit/rules.d/%' 
      AND filename LIKE '%.rules'
    );
  purpose: Informational
  tags: compliance, CIS, CIS_Level2, CIS-ubuntu-24.04-6.2.2.1
  contributors: allenhouchins

---
apiVersion: v1
kind: policy
spec:
  name: CIS - changes to system administration scope (sudoers) is collected
  platforms: Linux
  platform: linux
  description: |
    Monitor scope changes for system administrators.
  resolution: |
    Add the following lines to /etc/audit/rules.d/audit.rules:
    -w /etc/sudoers -p wa -k scope
    -w /etc/sudoers.d -p wa -k scope
  query: |
    SELECT 1 WHERE EXISTS (
      SELECT * FROM file 
      WHERE path LIKE '/etc/audit/rules.d/%' 
      AND filename LIKE '%.rules'
    );
  purpose: Informational
  tags: compliance, CIS, CIS_Level2, CIS-ubuntu-24.04-6.2.3.1
  contributors: allenhouchins

---
apiVersion: v1
kind: policy
spec:
  name: CIS - actions as another user (sudolog) are collected
  platforms: Linux
  platform: linux
  description: |
    Monitor the sudo log file. If the system has been properly configured to force sudo log files, the file /var/log/sudo.log is defined.
  resolution: |
    Add the following lines to /etc/audit/rules.d/50-actions.rules:
    -w /var/log/sudo.log -p wa -k actions
  query: |
    SELECT 1 WHERE EXISTS (
      SELECT * FROM file 
      WHERE path LIKE '/etc/audit/rules.d/%' 
      AND filename LIKE '%.rules'
    );
  purpose: Informational
  tags: compliance, CIS, CIS_Level2, CIS-ubuntu-24.04-6.2.3.2
  contributors: allenhouchins

---
apiVersion: v1
kind: policy
spec:
  name: CIS - events that modify date and time information are collected
  platforms: Linux
  platform: linux
  description: |
    Capture events where the system date and/or time has been modified.
  resolution: |
    Add the following lines to /etc/audit/rules.d/50-time-change.rules:
    -a always,exit -F arch=b64 -S adjtimex,settimeofday,clock_settime -k time-change
    -a always,exit -F arch=b32 -S adjtimex,settimeofday,clock_settime -k time-change
    -w /etc/localtime -p wa -k time-change
  query: |
    SELECT 1 WHERE EXISTS (
      SELECT * FROM file 
      WHERE path LIKE '/etc/audit/rules.d/%' 
      AND filename LIKE '%.rules'
    );
  purpose: Informational
  tags: compliance, CIS, CIS_Level2, CIS-ubuntu-24.04-6.2.3.3
  contributors: allenhouchins

---
apiVersion: v1
kind: policy
spec:
  name: CIS - events that modify the systems network environment are collected
  platforms: Linux
  platform: linux
  description: |
    Record changes to network environment files or system calls.
  resolution: |
    Add the following lines to /etc/audit/rules.d/50-system_locale.rules:
    -a always,exit -F arch=b64 -S sethostname,setdomainname -k system-locale
    -a always,exit -F arch=b32 -S sethostname,setdomainname -k system-locale
    -w /etc/issue -p wa -k system-locale
    -w /etc/issue.net -p wa -k system-locale
    -w /etc/hosts -p wa -k system-locale
    -w /etc/networks -p wa -k system-locale
    -w /etc/network/ -p wa -k system-locale
    -w /etc/netplan/ -p wa -k system-locale
  query: |
    SELECT 1 WHERE EXISTS (
      SELECT * FROM file 
      WHERE path LIKE '/etc/audit/rules.d/%' 
      AND filename LIKE '%.rules'
    );
  purpose: Informational
  tags: compliance, CIS, CIS_Level2, CIS-ubuntu-24.04-6.2.3.6
  contributors: allenhouchins

---
apiVersion: v1
kind: policy
spec:
  name: CIS - use of privileged commands are collected
  platforms: Linux
  platform: linux
  description: |
    Monitor privileged programs, those that have the setuid and/or setgid bit set on execution.
  resolution: |
    Find all setuid/setgid programs and create audit rules for them:
    # find / -xdev \( -perm -4000 -o -perm -2000 \) -type f | awk '{print "-a always,exit -F path=" $1 " -F perm=x -F auid>=1000 -F auid!=unset -k privileged" }' >> /etc/audit/rules.d/50-privileged.rules
  query: |
    SELECT 1 WHERE EXISTS (
      SELECT * FROM file 
      WHERE path LIKE '/etc/audit/rules.d/%' 
      AND filename LIKE '%.rules'
    );
  purpose: Informational
  tags: compliance, CIS, CIS_Level2, CIS-ubuntu-24.04-6.2.3.7
  contributors: allenhouchins

---
apiVersion: v1
kind: policy
spec:
  name: CIS - unsuccessful unauthorized file access attempts are collected
  platforms: Linux
  platform: linux
  description: |
    Monitor for unsuccessful attempts to access files.
  resolution: |
    Add the following lines to /etc/audit/rules.d/50-access.rules:
    -a always,exit -F arch=b64 -S creat,open,openat,truncate,ftruncate -F exit=-EACCES -F auid>=1000 -F auid!=unset -k access
    -a always,exit -F arch=b32 -S creat,open,openat,truncate,ftruncate -F exit=-EACCES -F auid>=1000 -F auid!=unset -k access
    -a always,exit -F arch=b64 -S creat,open,openat,truncate,ftruncate -F exit=-EPERM -F auid>=1000 -F auid!=unset -k access
    -a always,exit -F arch=b32 -S creat,open,openat,truncate,ftruncate -F exit=-EPERM -F auid>=1000 -F auid!=unset -k access
  query: |
    SELECT 1 WHERE EXISTS (
      SELECT * FROM file 
      WHERE path LIKE '/etc/audit/rules.d/%' 
      AND filename LIKE '%.rules'
    );
  purpose: Informational
  tags: compliance, CIS, CIS_Level2, CIS-ubuntu-24.04-6.2.3.8
  contributors: allenhouchins

---
apiVersion: v1
kind: policy
spec:
  name: CIS - events that modify user/group information are collected
  platforms: Linux
  platform: linux
  description: |
    Record events affecting the modification of user or group information including passwords.
  resolution: |
    Add the following lines to /etc/audit/rules.d/50-identity.rules:
    -w /etc/group -p wa -k identity
    -w /etc/passwd -p wa -k identity
    -w /etc/gshadow -p wa -k identity
    -w /etc/shadow -p wa -k identity
    -w /etc/security/opasswd -p wa -k identity
  query: |
    SELECT 1 WHERE EXISTS (
      SELECT * FROM file 
      WHERE path LIKE '/etc/audit/rules.d/%' 
      AND filename LIKE '%.rules'
    );
  purpose: Informational
  tags: compliance, CIS, CIS_Level2, CIS-ubuntu-24.04-6.2.3.9
  contributors: allenhouchins

---
apiVersion: v1
kind: policy
spec:
  name: CIS - discretionary access control permission modification events are collected
  platforms: Linux
  platform: linux
  description: |
    Monitor changes to file permissions, attributes, ownership and group.
  resolution: |
    Add the following lines to /etc/audit/rules.d/50-perm_mod.rules:
    -a always,exit -F arch=b64 -S chmod,fchmod,fchmodat -F auid>=1000 -F auid!=unset -F key=perm_mod
    -a always,exit -F arch=b64 -S chown,fchown,lchown,fchownat -F auid>=1000 -F auid!=unset -F key=perm_mod
    -a always,exit -F arch=b64 -S setxattr,lsetxattr,fsetxattr,removexattr,lremovexattr,fremovexattr -F auid>=1000 -F auid!=unset -F key=perm_mod
  query: |
    SELECT 1 WHERE EXISTS (
      SELECT * FROM file 
      WHERE path LIKE '/etc/audit/rules.d/%' 
      AND filename LIKE '%.rules'
    );
  purpose: Informational
  tags: compliance, CIS, CIS_Level2, CIS-ubuntu-24.04-6.2.3.10
  contributors: allenhouchins

---
apiVersion: v1
kind: policy
spec:
  name: CIS - successful file system mounts are collected
  platforms: Linux
  platform: linux
  description: |
    Monitor the use of the mount system call.
  resolution: |
    Add the following lines to /etc/audit/rules.d/50-mounts.rules:
    -a always,exit -F arch=b64 -S mount -F auid>=1000 -F auid!=unset -k mounts
    -a always,exit -F arch=b32 -S mount -F auid>=1000 -F auid!=unset -k mounts
  query: |
    SELECT 1 WHERE EXISTS (
      SELECT * FROM file 
      WHERE path LIKE '/etc/audit/rules.d/%' 
      AND filename LIKE '%.rules'
    );
  purpose: Informational
  tags: compliance, CIS, CIS_Level2, CIS-ubuntu-24.04-6.2.3.12
  contributors: allenhouchins

---
apiVersion: v1
kind: policy
spec:
  name: CIS - session initiation information is collected
  platforms: Linux
  platform: linux
  description: |
    Monitor session initiation events including login and logout.
  resolution: |
    Add the following lines to /etc/audit/rules.d/50-session.rules:
    -w /var/run/utmp -p wa -k session
    -w /var/log/wtmp -p wa -k logins
    -w /var/log/btmp -p wa -k logins
  query: |
    SELECT 1 WHERE EXISTS (
      SELECT * FROM file 
      WHERE path LIKE '/etc/audit/rules.d/%' 
      AND filename LIKE '%.rules'
    );
  purpose: Informational
  tags: compliance, CIS, CIS_Level2, CIS-ubuntu-24.04-6.2.3.13
  contributors: allenhouchins

---
apiVersion: v1
kind: policy
spec:
  name: CIS - kernel module loading unloading and modification is collected
  platforms: Linux
  platform: linux
  description: |
    Monitor the loading and unloading of kernel modules.
  resolution: |
    Add the following lines to /etc/audit/rules.d/50-kernel_modules.rules:
    -a always,exit -F arch=b64 -S init_module,finit_module,delete_module,create_module,query_module -F auid>=1000 -F auid!=unset -k kernel_modules
    -a always,exit -F path=/usr/bin/kmod -F perm=x -F auid>=1000 -F auid!=unset -k kernel_modules
  query: |
    SELECT 1 WHERE EXISTS (
      SELECT * FROM file 
      WHERE path LIKE '/etc/audit/rules.d/%' 
      AND filename LIKE '%.rules'
    );
  purpose: Informational
  tags: compliance, CIS, CIS_Level2, CIS-ubuntu-24.04-6.2.3.14
  contributors: allenhouchins

---
apiVersion: v1
kind: policy
spec:
  name: CIS - the audit configuration is immutable
  platforms: Linux
  platform: linux
  description: |
    Set system audit so that audit rules cannot be modified with auditctl.
  resolution: |
    Add the following line to the END of /etc/audit/rules.d/99-finalize.rules:
    -e 2
  query: |
    SELECT 1 WHERE EXISTS (
      SELECT * FROM file 
      WHERE path = '/etc/audit/rules.d/99-finalize.rules'
    );
  purpose: Informational
  tags: compliance, CIS, CIS_Level2, CIS-ubuntu-24.04-6.2.3.15
  contributors: allenhouchins

---
apiVersion: v1
kind: policy
spec:
  name: CIS - audit tools are owned by root
  platforms: Linux
  platform: linux
  description: |
    Audit tools include, but are not limited to, vendor-supplied and open source audit tools needed to successfully view and manipulate audit information system activity.
  resolution: |
    Run the following command to change ownership to root:
    # chown root /sbin/auditctl /sbin/aureport /sbin/ausearch /sbin/autrace /sbin/auditd /sbin/augenrules
  query: |
    SELECT 1 WHERE NOT EXISTS (
      SELECT * FROM file 
      WHERE path IN ('/sbin/auditctl', '/sbin/aureport', '/sbin/ausearch', '/sbin/autrace', '/sbin/auditd', '/sbin/augenrules')
      AND uid != 0
    );
  purpose: Informational
  tags: compliance, CIS, CIS_Level2, CIS-ubuntu-24.04-6.2.4.9
  contributors: allenhouchins

---
apiVersion: v1
kind: policy
spec:
  name: CIS - audit tools belong to group root
  platforms: Linux
  platform: linux
  description: |
    Protecting audit tools from unauthorized access and use is necessary to prevent unauthorized modification.
  resolution: |
    Run the following command to change group ownership to the group root:
    # chgrp root /sbin/auditctl /sbin/aureport /sbin/ausearch /sbin/autrace /sbin/auditd /sbin/augenrules
  query: |
    SELECT 1 WHERE NOT EXISTS (
      SELECT * FROM file 
      WHERE path IN ('/sbin/auditctl', '/sbin/aureport', '/sbin/ausearch', '/sbin/autrace', '/sbin/auditd', '/sbin/augenrules')
      AND gid != 0
    );
  purpose: Informational
  tags: compliance, CIS, CIS_Level2, CIS-ubuntu-24.04-6.2.4.10
  contributors: allenhouchins

# =============================================================================
# SECTION 5: ACCESS, AUTHENTICATION AND AUTHORIZATION - SSH SERVER CONFIGURATION
# =============================================================================

---
apiVersion: v1
kind: policy
spec:
  name: CIS - permissions on /etc/ssh/sshd_config are configured
  platforms: Linux
  platform: linux
  description: |
    The /etc/ssh/sshd_config file contains configuration specifications for sshd.
  resolution: |
    Run the following commands:
    # chown root:root /etc/ssh/sshd_config
    # chmod 600 /etc/ssh/sshd_config
  query: |
    SELECT 1 WHERE EXISTS (
      SELECT * FROM file 
      WHERE path = '/etc/ssh/sshd_config' 
      AND uid = 0 
      AND gid = 0 
      AND mode = '0600'
    ) OR NOT EXISTS (
      SELECT * FROM file WHERE path = '/etc/ssh/sshd_config'
    );
  purpose: Informational
  tags: compliance, CIS, CIS_Level1, CIS-ubuntu-24.04-5.1.1
  contributors: allenhouchins

---
apiVersion: v1
kind: policy
spec:
  name: CIS - permissions on SSH private host key files are configured
  platforms: Linux
  platform: linux
  description: |
    An SSH private host key is one of two files that together form a host key pair used during the SSH handshake to verify the server.
  resolution: |
    Run the following commands:
    # find /etc/ssh -xdev -type f -name 'ssh_host_*_key' -exec chmod 600 {} \;
    # find /etc/ssh -xdev -type f -name 'ssh_host_*_key' -exec chown root:root {} \;
  query: |
    SELECT 1 WHERE NOT EXISTS (
      SELECT * FROM file 
      WHERE path LIKE '/etc/ssh/ssh_host_%_key' 
      AND (uid != 0 OR gid != 0 OR mode != '0600')
    );
  purpose: Informational
  tags: compliance, CIS, CIS_Level1, CIS-ubuntu-24.04-5.1.2
  contributors: allenhouchins

---
apiVersion: v1
kind: policy
spec:
  name: CIS - permissions on SSH public host key files are configured
  platforms: Linux
  platform: linux
  description: |
    An SSH public host key is one of two files that together form a host key pair used during the SSH handshake to verify the server.
  resolution: |
    Run the following commands:
    # find /etc/ssh -xdev -type f -name 'ssh_host_*_key.pub' -exec chmod 644 {} \;
    # find /etc/ssh -xdev -type f -name 'ssh_host_*_key.pub' -exec chown root:root {} \;
  query: |
    SELECT 1 WHERE NOT EXISTS (
      SELECT * FROM file 
      WHERE path LIKE '/etc/ssh/ssh_host_%_key.pub' 
      AND (uid != 0 OR gid != 0 OR mode != '0644')
    );
  purpose: Informational
  tags: compliance, CIS, CIS_Level1, CIS-ubuntu-24.04-5.1.3
  contributors: allenhouchins

---
apiVersion: v1
kind: policy
spec:
  name: CIS - SSH access is limited
  platforms: Linux
  platform: linux
  description: |
    There are several options available to limit which users and group can access the system via SSH.
  resolution: |
    Edit /etc/ssh/sshd_config and set one or more of:
    AllowUsers <list>
    AllowGroups <list>
    DenyUsers <list>
    DenyGroups <list>
  query: |
    SELECT 1 WHERE EXISTS (
      SELECT * FROM augeas 
      WHERE path LIKE '/etc/ssh/sshd_config'
      AND label = 'AllowUsers'
      OR path LIKE '/etc/ssh/sshd_config'
      AND label = 'AllowGroups'
      OR path LIKE '/etc/ssh/sshd_config'
      AND label = 'DenyUsers'
      OR path LIKE '/etc/ssh/sshd_config'
      AND label = 'DenyGroups'
    ) OR NOT EXISTS (
      SELECT * FROM listening_ports WHERE port = 22 AND protocol = 6
    );
  purpose: Informational
  tags: compliance, CIS, CIS_Level1, CIS-ubuntu-24.04-5.1.4
  contributors: allenhouchins

---
apiVersion: v1
kind: policy
spec:
  name: CIS - SSH LogLevel is appropriate
  platforms: Linux
  platform: linux
  description: |
    INFO level is the basic level that only records login activity.
  resolution: |
    Edit the /etc/ssh/sshd_config file to set the parameter:
    LogLevel VERBOSE
    or
    LogLevel INFO
  query: |
    SELECT 1 WHERE EXISTS (
      SELECT * FROM augeas 
      WHERE path = '/etc/ssh/sshd_config' 
      AND label = 'LogLevel'
      AND (value = 'VERBOSE' OR value = 'INFO')
    ) OR NOT EXISTS (
      SELECT * FROM listening_ports WHERE port = 22 AND protocol = 6
    );
  purpose: Informational
  tags: compliance, CIS, CIS_Level1, CIS-ubuntu-24.04-5.1.5
  contributors: allenhouchins

---
apiVersion: v1
kind: policy
spec:
  name: CIS - SSH PAM is enabled
  platforms: Linux
  platform: linux
  description: |
    UsePAM enables the Pluggable Authentication Module interface.
  resolution: |
    Edit the /etc/ssh/sshd_config file to set the parameter:
    UsePAM yes
  query: |
    SELECT 1 WHERE EXISTS (
      SELECT * FROM augeas 
      WHERE path = '/etc/ssh/sshd_config' 
      AND label = 'UsePAM'
      AND value = 'yes'
    ) OR NOT EXISTS (
      SELECT * FROM listening_ports WHERE port = 22 AND protocol = 6
    );
  purpose: Informational
  tags: compliance, CIS, CIS_Level1, CIS-ubuntu-24.04-5.1.6
  contributors: allenhouchins

---
apiVersion: v1
kind: policy
spec:
  name: CIS - SSH root login is disabled
  platforms: Linux
  platform: linux
  description: |
    The PermitRootLogin parameter specifies if the root user can log in using ssh.
  resolution: |
    Edit the /etc/ssh/sshd_config file to set the parameter:
    PermitRootLogin no
  query: |
    SELECT 1 WHERE EXISTS (
      SELECT * FROM augeas 
      WHERE path = '/etc/ssh/sshd_config' 
      AND label = 'PermitRootLogin'
      AND value = 'no'
    ) OR NOT EXISTS (
      SELECT * FROM listening_ports WHERE port = 22 AND protocol = 6
    );
  purpose: Informational
  tags: compliance, CIS, CIS_Level1, CIS-ubuntu-24.04-5.1.7
  contributors: allenhouchins

---
apiVersion: v1
kind: policy
spec:
  name: CIS - SSH HostbasedAuthentication is disabled
  platforms: Linux
  platform: linux
  description: |
    The HostbasedAuthentication parameter specifies if authentication is allowed through trusted hosts.
  resolution: |
    Edit the /etc/ssh/sshd_config file to set the parameter:
    HostbasedAuthentication no
  query: |
    SELECT 1 WHERE EXISTS (
      SELECT * FROM augeas 
      WHERE path = '/etc/ssh/sshd_config'
      AND label = 'HostbasedAuthentication'
      AND value = 'no'
    ) OR NOT EXISTS (
      SELECT * FROM listening_ports WHERE port = 22 AND protocol = 6
    );
  purpose: Informational
  tags: compliance, CIS, CIS_Level1, CIS-ubuntu-24.04-5.1.8
  contributors: allenhouchins

---
apiVersion: v1
kind: policy
spec:
  name: CIS - SSH PermitEmptyPasswords is disabled
  platforms: Linux
  platform: linux
  description: |
    The PermitEmptyPasswords parameter specifies if the SSH server allows login to accounts with empty password strings.
  resolution: |
    Edit the /etc/ssh/sshd_config file to set the parameter:
    PermitEmptyPasswords no
  query: |
    SELECT 1 WHERE EXISTS (
      SELECT * FROM augeas 
      WHERE path = '/etc/ssh/sshd_config' 
      AND label = 'PermitEmptyPasswords'
      AND value = 'no'
    ) OR NOT EXISTS (
      SELECT * FROM listening_ports WHERE port = 22 AND protocol = 6
    );
  purpose: Informational
  tags: compliance, CIS, CIS_Level1, CIS-ubuntu-24.04-5.1.9
  contributors: allenhouchins

---
apiVersion: v1
kind: policy
spec:
  name: CIS - SSH PermitUserEnvironment is disabled
  platforms: Linux
  platform: linux
  description: |
    The PermitUserEnvironment option allows users to present environment variables to the ssh daemon.
  resolution: |
    Edit the /etc/ssh/sshd_config file to set the parameter:
    PermitUserEnvironment no
  query: |
    SELECT 1 WHERE NOT EXISTS (
      SELECT * FROM augeas 
      WHERE path = '/etc/ssh/sshd_config' 
      AND label = 'PermitUserEnvironment'
      AND value != 'no'
    ) OR NOT EXISTS (
      SELECT * FROM listening_ports 
      WHERE port = 22 AND protocol = 6
    );
  purpose: Informational
  tags: compliance, CIS, CIS_Level1, CIS-ubuntu-24.04-5.1.10
  contributors: allenhouchins

---
apiVersion: v1
kind: policy
spec:
  name: CIS - SSH IgnoreRhosts is enabled
  platforms: Linux
  platform: linux
  description: |
    The IgnoreRhosts parameter specifies that .rhosts and .shosts files will not be used in RhostsRSAAuthentication or HostbasedAuthentication.
  resolution: |
    Edit the /etc/ssh/sshd_config file to set the parameter:
    IgnoreRhosts yes
  query: |
    SELECT 1 WHERE NOT EXISTS (
      SELECT * FROM augeas 
      WHERE path = '/etc/ssh/sshd_config' 
      AND label = 'IgnoreRhosts'
      AND value != 'yes'
    ) OR NOT EXISTS (
      SELECT * FROM listening_ports 
      WHERE port = 22 AND protocol = 6
    );
  purpose: Informational
  tags: compliance, CIS, CIS_Level1, CIS-ubuntu-24.04-5.1.11
  contributors: allenhouchins

---
apiVersion: v1
kind: policy
spec:
  name: CIS - SSH X11 forwarding is disabled
  platforms: Linux
  platform: linux
  description: |
    The X11Forwarding parameter provides the ability to tunnel X11 traffic through the connection.
  resolution: |
    Edit the /etc/ssh/sshd_config file to set the parameter:
    X11Forwarding no
  query: |
    SELECT 1 WHERE NOT EXISTS (
      SELECT * FROM augeas 
      WHERE path = '/etc/ssh/sshd_config' 
      AND label = 'X11Forwarding'
      AND value != 'no'
    ) OR NOT EXISTS (
      SELECT * FROM listening_ports 
      WHERE port = 22 AND protocol = 6
    );
  purpose: Informational
  tags: compliance, CIS, CIS_Level2, CIS-ubuntu-24.04-5.1.12
  contributors: allenhouchins

---
apiVersion: v1
kind: policy
spec:
  name: CIS - only strong Ciphers are used
  platforms: Linux
  platform: linux
  description: |
    This variable limits the ciphers that SSH can use during communication.
  resolution: |
    Edit the /etc/ssh/sshd_config file to set the parameter:
    Ciphers chacha20-poly1305@openssh.com,aes256-gcm@openssh.com,aes128-gcm@openssh.com,aes256-ctr,aes192-ctr,aes128-ctr
  query: |
    SELECT 1 WHERE EXISTS (
      SELECT * FROM augeas 
      WHERE path = '/etc/ssh/sshd_config'
      AND label = 'Ciphers'
    ) OR NOT EXISTS (
      SELECT * FROM listening_ports WHERE port = 22 AND protocol = 6
    );
  purpose: Informational
  tags: compliance, CIS, CIS_Level1, CIS-ubuntu-24.04-5.1.13
  contributors: allenhouchins

---
apiVersion: v1
kind: policy
spec:
  name: CIS - only strong Key Exchange algorithms are used
  platforms: Linux
  platform: linux
  description: |
    Key exchange is any method in cryptography by which cryptographic keys are exchanged between two parties.
  resolution: |
    Edit the /etc/ssh/sshd_config file to set the parameter:
    KexAlgorithms curve25519-sha256,curve25519-sha256@libssh.org,diffie-hellman-group14-sha256,diffie-hellman-group16-sha512,diffie-hellman-group18-sha512,ecdh-sha2-nistp521,ecdh-sha2-nistp384,ecdh-sha2-nistp256,diffie-hellman-group-exchange-sha256
  query: |
    SELECT 1 WHERE EXISTS (
      SELECT * FROM augeas 
      WHERE path = '/etc/ssh/sshd_config'
      AND label = 'KexAlgorithms'
    ) OR NOT EXISTS (
      SELECT * FROM listening_ports WHERE port = 22 AND protocol = 6
    );
  purpose: Informational
  tags: compliance, CIS, CIS_Level1, CIS-ubuntu-24.04-5.1.14
  contributors: allenhouchins

---
apiVersion: v1
kind: policy
spec:
  name: CIS - only strong MAC algorithms are used
  platforms: Linux
  platform: linux
  description: |
    This variable limits the types of MAC algorithms that SSH can use during communication.
  resolution: |
    Edit the /etc/ssh/sshd_config file to set the parameter:
    MACs hmac-sha2-512-etm@openssh.com,hmac-sha2-256-etm@openssh.com,hmac-sha2-512,hmac-sha2-256
  query: |
    SELECT 1 WHERE EXISTS (
      SELECT * FROM augeas 
      WHERE path = '/etc/ssh/sshd_config'
      AND label = 'MACs'
    ) OR NOT EXISTS (
      SELECT * FROM listening_ports WHERE port = 22 AND protocol = 6
    );
  purpose: Informational
  tags: compliance, CIS, CIS_Level1, CIS-ubuntu-24.04-5.1.15
  contributors: allenhouchins

---
apiVersion: v1
kind: policy
spec:
  name: CIS - SSH warning banner is configured
  platforms: Linux
  platform: linux
  description: |
    The Banner parameter specifies a file whose contents must be sent to the remote user before authentication is permitted.
  resolution: |
    Edit the /etc/ssh/sshd_config file to set the parameter:
    Banner /etc/issue.net
  query: |
    SELECT 1 WHERE EXISTS (
      SELECT * FROM augeas 
      WHERE path = '/etc/ssh/sshd_config' 
      AND label = 'Banner' 
      AND value = '/etc/issue.net'
    ) OR NOT EXISTS (
      SELECT * FROM listening_ports 
      WHERE port = 22 
      AND protocol = 6
    );
  purpose: Informational
  tags: compliance, CIS, CIS_Level1, CIS-ubuntu-24.04-5.1.16
  contributors: allenhouchins

---
apiVersion: v1
kind: policy
spec:
  name: CIS - SSH MaxAuthTries is 4 or less
  platforms: Linux
  platform: linux
  description: |
    The MaxAuthTries parameter specifies the maximum number of authentication attempts permitted per connection.
  resolution: |
    Edit the /etc/ssh/sshd_config file to set the parameter:
    MaxAuthTries 4
  query: |
    SELECT 1 WHERE EXISTS (
      SELECT * FROM augeas
      WHERE path = '/etc/ssh/sshd_config' 
      AND label = 'MaxAuthTries'
      AND CAST(value AS INTEGER) <= 4
    ) OR NOT EXISTS (
      SELECT * FROM listening_ports WHERE port = 22 AND protocol = 6
    );
  purpose: Informational
  tags: compliance, CIS, CIS_Level1, CIS-ubuntu-24.04-5.1.17
  contributors: allenhouchins

---
apiVersion: v1
kind: policy
spec:
  name: CIS - SSH MaxStartups is configured
  platforms: Linux
  platform: linux
  description: |
    The MaxStartups parameter specifies the maximum number of concurrent unauthenticated connections to the SSH daemon.
  resolution: |
    Edit the /etc/ssh/sshd_config file to set the parameter:
    MaxStartups 10:30:60
  query: |
    SELECT 1 WHERE EXISTS (
      SELECT * FROM augeas 
      WHERE path = '/etc/ssh/sshd_config'
      AND label = 'MaxStartups'
    ) OR NOT EXISTS (
      SELECT * FROM listening_ports WHERE port = 22 AND protocol = 6
    );
  purpose: Informational
  tags: compliance, CIS, CIS_Level1, CIS-ubuntu-24.04-5.1.18
  contributors: allenhouchins

---
apiVersion: v1
kind: policy
spec:
  name: CIS - SSH LoginGraceTime is one minute or less
  platforms: Linux
  platform: linux
  description: |
    The LoginGraceTime parameter specifies the time allowed for successful authentication to the SSH server.
  resolution: |
    Edit the /etc/ssh/sshd_config file to set the parameter:
    LoginGraceTime 60
  query: |
    SELECT 1 WHERE EXISTS (
      SELECT * FROM augeas 
      WHERE path = '/etc/ssh/sshd_config' 
      AND label = 'LoginGraceTime'
      AND CAST(value AS INTEGER) <= 60
    ) OR NOT EXISTS (
      SELECT * FROM listening_ports WHERE port = 22 AND protocol = 6
    );
  purpose: Informational
  tags: compliance, CIS, CIS_Level1, CIS-ubuntu-24.04-5.1.19
  contributors: allenhouchins

---
apiVersion: v1
kind: policy
spec:
  name: CIS - SSH ClientAliveInterval and ClientAliveCountMax are configured
  platforms: Linux
  platform: linux
  description: |
    The ClientAliveInterval and ClientAliveCountMax parameters specify the server's timeout configuration.
  resolution: |
    Edit the /etc/ssh/sshd_config file to set the parameters:
    ClientAliveInterval 15
    ClientAliveCountMax 3
  query: |
    SELECT 1 WHERE EXISTS (
      SELECT * FROM augeas 
      WHERE path = '/etc/ssh/sshd_config' 
      AND label = 'ClientAliveInterval'
      AND CAST(value AS INTEGER) > 0 
      AND CAST(value AS INTEGER) <= 300
    ) OR NOT EXISTS (
      SELECT * FROM listening_ports WHERE port = 22 AND protocol = 6
    );
  purpose: Informational
  tags: compliance, CIS, CIS_Level1, CIS-ubuntu-24.04-5.1.21
  contributors: allenhouchins

---
apiVersion: v1
kind: policy
spec:
  name: CIS - SSH MaxSessions is limited
  platforms: Linux
  platform: linux
  description: |
    The MaxSessions parameter specifies the maximum number of open sessions permitted from a given connection.
  resolution: |
    Edit the /etc/ssh/sshd_config file to set the parameter:
    MaxSessions 10
  query: |
    SELECT 1 WHERE EXISTS (
      SELECT * FROM augeas 
      WHERE path = '/etc/ssh/sshd_config' 
      AND label = 'MaxSessions'
      AND CAST(value AS INTEGER) <= 10
    ) OR NOT EXISTS (
      SELECT * FROM listening_ports 
      WHERE port = 22 AND protocol = 6
    );
  purpose: Informational
  tags: compliance, CIS, CIS_Level1, CIS-ubuntu-24.04-5.1.24
  contributors: allenhouchins

# =============================================================================
# SECTION 5: ACCESS CONTROL - CONFIGURE PAM
# =============================================================================

---
apiVersion: v1
kind: policy
spec:
  name: CIS - password creation requirements are configured
  platforms: Linux
  platform: linux
  description: |
    The pam_pwquality.so module checks the strength of passwords.
  resolution: |
    Edit the /etc/security/pwquality.conf file to set password requirements:
    minlen = 14
    dcredit = -1
    ucredit = -1
    ocredit = -1
    lcredit = -1
  query: |
    SELECT 1 WHERE EXISTS (
      SELECT * FROM file 
      WHERE path = '/etc/security/pwquality.conf'
    );
  purpose: Informational
  tags: compliance, CIS, CIS_Level1, CIS-ubuntu-24.04-5.4.1
  contributors: allenhouchins

---
apiVersion: v1
kind: policy
spec:
  name: CIS - lockout for failed password attempts is configured
  platforms: Linux
  platform: linux
  description: |
    Lock out users after n unsuccessful consecutive login attempts.
  resolution: |
    Edit the /etc/pam.d/common-auth file and add:
    auth required pam_faillock.so preauth
    auth required pam_faillock.so authfail
    Edit /etc/security/faillock.conf and set:
    deny = 4
    unlock_time = 900
  query: |
    SELECT 1 WHERE EXISTS (
      SELECT * FROM file 
      WHERE path = '/etc/pam.d/common-auth'
    ) AND EXISTS (
      SELECT * FROM file 
      WHERE path = '/etc/security/faillock.conf'
    );
  purpose: Informational
  tags: compliance, CIS, CIS_Level1, CIS-ubuntu-24.04-5.4.2
  contributors: allenhouchins

---
apiVersion: v1
kind: policy
spec:
  name: CIS - password reuse is limited
  platforms: Linux
  platform: linux
  description: |
    The /etc/security/opasswd file stores the users' old passwords and can be checked to ensure users are not recycling recent passwords.
  resolution: |
    Edit the /etc/pam.d/common-password file and add:
    password required pam_pwhistory.so remember=24 enforce_for_root
  query: |
    SELECT 1 WHERE EXISTS (
      SELECT * FROM file 
      WHERE path = '/etc/pam.d/common-password'
    );
  purpose: Informational
  tags: compliance, CIS, CIS_Level1, CIS-ubuntu-24.04-5.4.3
  contributors: allenhouchins

---
apiVersion: v1
kind: policy
spec:
  name: CIS - password hashing algorithm is sha512
  platforms: Linux
  platform: linux
  description: |
    The sha512 algorithm provides stronger hashing than md5 or sha256.
  resolution: |
    Edit /etc/pam.d/common-password and ensure the pam_unix.so line includes sha512:
    password [success=1 default=ignore] pam_unix.so sha512
  query: |
    SELECT 1 WHERE EXISTS (
      SELECT * FROM file 
      WHERE path = '/etc/pam.d/common-password'
    );
  purpose: Informational
  tags: compliance, CIS, CIS_Level1, CIS-ubuntu-24.04-5.4.4
  contributors: allenhouchins

---
apiVersion: v1
kind: policy
spec:
  name: CIS - minimum days between password changes is configured
  platforms: Linux
  platform: linux
  description: |
    The PASS_MIN_DAYS parameter in /etc/login.defs allows an administrator to prevent users from changing their password until a minimum number of days have passed.
  resolution: |
    Set PASS_MIN_DAYS to 1 in /etc/login.defs:
    PASS_MIN_DAYS 1
  query: |
    SELECT 1 WHERE EXISTS (
      SELECT * FROM augeas 
      WHERE path = '/etc/login.defs' 
      AND label = 'PASS_MIN_DAYS'
      AND CAST(value AS INTEGER) >= 1
    );
  purpose: Informational
  tags: compliance, CIS, CIS_Level1, CIS-ubuntu-24.04-5.5.1.2
  contributors: allenhouchins

---
apiVersion: v1
kind: policy
spec:
  name: CIS - password expiration is 365 days or less
  platforms: Linux
  platform: linux
  description: |
    The PASS_MAX_DAYS parameter in /etc/login.defs allows an administrator to force passwords to expire once they reach a defined age.
  resolution: |
    Set PASS_MAX_DAYS to 365 or less in /etc/login.defs:
    PASS_MAX_DAYS 365
  query: |
    SELECT 1 WHERE EXISTS (
      SELECT * FROM augeas 
      WHERE path = '/etc/login.defs' 
      AND label = 'PASS_MAX_DAYS'
      AND CAST(value AS INTEGER) <= 365
    );
  purpose: Informational
  tags: compliance, CIS, CIS_Level1, CIS-ubuntu-24.04-5.5.1.3
  contributors: allenhouchins

---
apiVersion: v1
kind: policy
spec:
  name: CIS - password expiration warning days is 7 or more
  platforms: Linux
  platform: linux
  description: |
    The PASS_WARN_AGE parameter in /etc/login.defs allows an administrator to notify users that their password will expire in a defined number of days.
  resolution: |
    Set PASS_WARN_AGE to 7 or more in /etc/login.defs:
    PASS_WARN_AGE 7
  query: |
    SELECT 1 WHERE EXISTS (
      SELECT * FROM augeas 
      WHERE path = '/etc/login.defs'
      AND label = 'PASS_WARN_AGE'
      AND CAST(value AS INTEGER) >= 7
    );
  purpose: Informational
  tags: compliance, CIS, CIS_Level1, CIS-ubuntu-24.04-5.5.1.4
  contributors: allenhouchins

---
apiVersion: v1
kind: policy
spec:
  name: CIS - inactive password lock is 30 days or less
  platforms: Linux
  platform: linux
  description: |
    User accounts that have been inactive for over a given period of time can be automatically disabled.
  resolution: |
    Run the following command to set the default password inactivity period to 30 days:
    # useradd -D -f 30
  query: |
    SELECT 1 WHERE EXISTS (
      SELECT * FROM augeas 
      WHERE path = '/etc/default/useradd' 
      AND label = 'INACTIVE'
      AND CAST(value AS INTEGER) <= 30
    );
  purpose: Informational
  tags: compliance, CIS, CIS_Level1, CIS-ubuntu-24.04-5.5.1.5
  contributors: allenhouchins

---
apiVersion: v1
kind: policy
spec:
  name: CIS - default group for the root account is GID 0
  platforms: Linux
  platform: linux
  description: |
    The usermod command can be used to specify which group the root user belongs to.
  resolution: |
    Run the following command to set the root user default group to GID 0:
    # usermod -g 0 root
  query: |
    SELECT 1 WHERE EXISTS (
      SELECT * FROM users 
      WHERE username = 'root' 
      AND gid = 0
    );
  purpose: Informational
  tags: compliance, CIS, CIS_Level1, CIS-ubuntu-24.04-5.5.3
  contributors: allenhouchins

---
apiVersion: v1
kind: policy
spec:
  name: CIS - default umask for users is configured
  platforms: Linux
  platform: linux
  description: |
    The default umask determines the default permissions for newly created files.
  resolution: |
    Edit /etc/bash.bashrc and /etc/profile to set:
    umask 027
  query: |
    SELECT 1 WHERE EXISTS (
      SELECT * FROM file 
      WHERE path = '/etc/bash.bashrc'
    ) AND EXISTS (
      SELECT * FROM file 
      WHERE path = '/etc/profile'
    );
  purpose: Informational
  tags: compliance, CIS, CIS_Level1, CIS-ubuntu-24.04-5.5.4
  contributors: allenhouchins

---
apiVersion: v1
kind: policy
spec:
  name: CIS - shell timeout is configured
  platforms: Linux
  platform: linux
  description: |
    Setting a timeout value reduces the window of opportunity for unauthorized user access to another user's shell session.
  resolution: |
    Create or edit /etc/profile.d/timeout.sh and add:
    readonly TMOUT=900
    export TMOUT
  query: |
    SELECT 1 WHERE EXISTS (
      SELECT * FROM file 
      WHERE path = '/etc/profile.d/timeout.sh'
    );
  purpose: Informational
  tags: compliance, CIS, CIS_Level1, CIS-ubuntu-24.04-5.5.5
  contributors: allenhouchins

# =============================================================================
# SECTION 7: SYSTEM MAINTENANCE - FILE PERMISSIONS AND OWNERSHIP
# =============================================================================

---
apiVersion: v1
kind: policy
spec:
  name: CIS - permissions on /etc/passwd are configured
  platforms: Linux
  platform: linux
  description: |
    The /etc/passwd file contains user account information that is used by many system utilities.
  resolution: |
    Run the following commands:
    # chown root:root /etc/passwd
    # chmod 644 /etc/passwd
  query: |
    SELECT 1 WHERE EXISTS (
      SELECT * FROM file 
      WHERE path = '/etc/passwd' 
      AND uid = 0 
      AND gid = 0 
      AND mode = '0644'
    );
  purpose: Informational
  tags: compliance, CIS, CIS_Level1, CIS-ubuntu-24.04-7.1.1
  contributors: allenhouchins

---
apiVersion: v1
kind: policy
spec:
  name: CIS - permissions on /etc/passwd- are configured
  platforms: Linux
  platform: linux
  description: |
    The /etc/passwd- file contains backup user account information.
  resolution: |
    Run the following commands:
    # chown root:root /etc/passwd-
    # chmod 600 /etc/passwd-
  query: |
    SELECT 1 WHERE EXISTS (
      SELECT * FROM file 
      WHERE path = '/etc/passwd-' 
      AND uid = 0 
      AND gid = 0 
      AND mode = '0600'
    );
  purpose: Informational
  tags: compliance, CIS, CIS_Level1, CIS-ubuntu-24.04-7.1.2
  contributors: allenhouchins

---
apiVersion: v1
kind: policy
spec:
  name: CIS - permissions on /etc/group are configured
  platforms: Linux
  platform: linux
  description: |
    The /etc/group file contains a list of all the valid groups defined in the system.
  resolution: |
    Run the following commands:
    # chown root:root /etc/group
    # chmod 644 /etc/group
  query: |
    SELECT 1 WHERE EXISTS (
      SELECT * FROM file 
      WHERE path = '/etc/group' 
      AND uid = 0 
      AND gid = 0 
      AND mode = '0644'
    );
  purpose: Informational
  tags: compliance, CIS, CIS_Level1, CIS-ubuntu-24.04-7.1.3
  contributors: allenhouchins

---
apiVersion: v1
kind: policy
spec:
  name: CIS - permissions on /etc/group- are configured
  platforms: Linux
  platform: linux
  description: |
    The /etc/group- file contains backup information about groups.
  resolution: |
    Run the following commands:
    # chown root:root /etc/group-
    # chmod 600 /etc/group-
  query: |
    SELECT 1 WHERE EXISTS (
      SELECT * FROM file 
      WHERE path = '/etc/group-' 
      AND uid = 0 
      AND gid = 0 
      AND mode = '0600'
    );
  purpose: Informational
  tags: compliance, CIS, CIS_Level1, CIS-ubuntu-24.04-7.1.4
  contributors: allenhouchins

---
apiVersion: v1
kind: policy
spec:
  name: CIS - permissions on /etc/shadow are configured
  platforms: Linux
  platform: linux
  description: |
    The /etc/shadow file is used to store the information about user accounts that is critical to the security of those accounts.
  resolution: |
    Run the following commands:
    # chown root:shadow /etc/shadow
    # chmod 640 /etc/shadow
  query: |
    SELECT 1 WHERE EXISTS (
      SELECT * FROM file 
      WHERE path = '/etc/shadow' 
      AND uid = 0 
      AND mode = '0640'
    );
  purpose: Informational
  tags: compliance, CIS, CIS_Level1, CIS-ubuntu-24.04-7.1.5
  contributors: allenhouchins

---
apiVersion: v1
kind: policy
spec:
  name: CIS - permissions on /etc/shadow- are configured
  platforms: Linux
  platform: linux
  description: |
    The /etc/shadow- file is used to store backup information about user accounts.
  resolution: |
    Run the following commands:
    # chown root:shadow /etc/shadow-
    # chmod 640 /etc/shadow-
  query: |
    SELECT 1 WHERE EXISTS (
      SELECT * FROM file 
      WHERE path = '/etc/shadow-' 
      AND uid = 0 
      AND mode = '0640'
    );
  purpose: Informational
  tags: compliance, CIS, CIS_Level1, CIS-ubuntu-24.04-7.1.6
  contributors: allenhouchins

---
apiVersion: v1
kind: policy
spec:
  name: CIS - permissions on /etc/gshadow are configured
  platforms: Linux
  platform: linux
  description: |
    The /etc/gshadow file is used to store the information about groups that is critical to the security of those accounts.
  resolution: |
    Run the following commands:
    # chown root:shadow /etc/gshadow
    # chmod 640 /etc/gshadow
  query: |
    SELECT 1 WHERE EXISTS (
      SELECT * FROM file 
      WHERE path = '/etc/gshadow' 
      AND uid = 0 
      AND mode = '0640'
    );
  purpose: Informational
  tags: compliance, CIS, CIS_Level1, CIS-ubuntu-24.04-7.1.7
  contributors: allenhouchins

---
apiVersion: v1
kind: policy
spec:
  name: CIS - permissions on /etc/gshadow- are configured
  platforms: Linux
  platform: linux
  description: |
    The /etc/gshadow- file is used to store backup information about groups.
  resolution: |
    Run the following commands:
    # chown root:shadow /etc/gshadow-
    # chmod 640 /etc/gshadow-
  query: |
    SELECT 1 WHERE EXISTS (
      SELECT * FROM file 
      WHERE path = '/etc/gshadow-' 
      AND uid = 0 
      AND mode = '0640'
    );
  purpose: Informational
  tags: compliance, CIS, CIS_Level1, CIS-ubuntu-24.04-7.1.8
  contributors: allenhouchins

---
apiVersion: v1
kind: policy
spec:
  name: CIS - world writable files do not exist (comprehensive)
  platforms: Linux
  platform: linux
  description: |
    Unix-based systems support variable settings to control access to files. World writable files are files that any user can write to.
  resolution: |
    Remove world write permissions from all files:
    # find / -xdev -type f -perm -0002 -exec chmod o-w {} \;
  query: |
    SELECT 1 WHERE NOT EXISTS (
      SELECT 1 FROM file f
      WHERE f.mode LIKE '%2' 
        AND f.type = 'regular'
        AND f.directory IN (
          '/etc', '/bin', '/sbin', '/usr/bin', '/usr/sbin', 
          '/usr/local/bin', '/usr/local/sbin', '/var/log', 
          '/var/lib', '/var/www', '/opt', '/root'
        )
    ) AND NOT EXISTS (
      SELECT 1 FROM file f
      WHERE f.mode LIKE '%2' 
        AND f.type = 'regular'
        AND f.directory LIKE '/home/%'
    ) AND NOT EXISTS (
      SELECT 1 FROM file f
      WHERE f.mode LIKE '%2' 
        AND f.type = 'regular'
        AND f.directory LIKE '/usr/share/%'
    ) AND NOT EXISTS (
      SELECT 1 FROM file f
      WHERE f.mode LIKE '%2' 
        AND f.type = 'regular'
        AND f.directory LIKE '/var/spool/%'
        AND f.path NOT LIKE '/var/spool/mail/%'
    );
  purpose: Informational
  tags: compliance, CIS, CIS_Level1, CIS-ubuntu-24.04-7.1.9
  contributors: allenhouchins

---
apiVersion: v1
kind: policy
spec:
  name: CIS - no unowned files or directories exist
  platforms: Linux
  platform: linux
  description: |
    Sometimes when administrators delete users from the passwd file they neglect to remove all files owned by those users from the system.
  resolution: |
    Locate files that are owned by users or groups not listed in the system configuration files, and reset the ownership of these files to some active user on the system.
  query: |
    SELECT 1 WHERE NOT EXISTS (
      SELECT 1 FROM file f 
      LEFT JOIN users u ON f.uid = u.uid 
      WHERE u.uid IS NULL 
        AND f.directory IN (
          '/etc', '/bin', '/sbin', '/usr/bin', '/usr/sbin', 
          '/usr/local/bin', '/usr/local/sbin', '/var/log', 
          '/var/lib', '/opt', '/root'
        )
    ) AND NOT EXISTS (
      SELECT 1 FROM file f 
      LEFT JOIN users u ON f.uid = u.uid 
      WHERE u.uid IS NULL 
        AND f.directory LIKE '/home/%'
    );
  purpose: Informational
  tags: compliance, CIS, CIS_Level1, CIS-ubuntu-24.04-7.1.10
  contributors: allenhouchins

---
apiVersion: v1
kind: policy
spec:
  name: CIS - no ungrouped files or directories exist (optimized)
  platforms: Linux
  platform: linux
  description: |
    Sometimes when administrators delete groups from the /etc/group file they neglect to remove all files owned by those groups from the system.
  resolution: |
    Locate files that are owned by groups not listed in the system configuration files, and reset the ownership of these files to an active group.
  query: |
    SELECT 1 WHERE NOT EXISTS (
      SELECT 1 FROM file f 
      LEFT JOIN groups g ON f.gid = g.gid 
      WHERE g.gid IS NULL 
        AND f.directory IN (
          '/etc', '/bin', '/sbin', '/usr/bin', '/usr/sbin', 
          '/usr/local/bin', '/usr/local/sbin', '/var/log', 
          '/var/lib', '/opt', '/root'
        )
    ) AND NOT EXISTS (
      SELECT 1 FROM file f 
      LEFT JOIN groups g ON f.gid = g.gid 
      WHERE g.gid IS NULL 
        AND f.directory LIKE '/home/%'
    );
  purpose: Informational
  tags: compliance, CIS, CIS_Level1, CIS-ubuntu-24.04-7.1.11
  contributors: allenhouchins

# =============================================================================
# SECTION 7: SYSTEM MAINTENANCE - USER AND GROUP SETTINGS
# =============================================================================

---
apiVersion: v1
kind: policy
spec:
  name: CIS - system accounts are secured
  platforms: Linux
  platform: linux
  description: |
    There are a number of accounts provided with most distributions that are used to manage applications and are not intended to provide an interactive shell.
  resolution: |
    Set the shell for any accounts returned by the audit to nologin:
    # usermod -s /usr/sbin/nologin <user>
  query: |
    SELECT 1 WHERE NOT EXISTS (
      SELECT * FROM users 
      WHERE uid < 1000 
      AND uid != 0 
      AND shell NOT IN ('/usr/sbin/nologin', '/bin/false', '/sbin/nologin')
    );
  purpose: Informational
  tags: compliance, CIS, CIS_Level1, CIS-ubuntu-24.04-7.2.1
  contributors: allenhouchins

---
apiVersion: v1
kind: policy
spec:
  name: CIS - shadow group is empty
  platforms: Linux
  platform: linux
  description: |
    The shadow group allows system programs which require access the ability to read the /etc/shadow file.
  resolution: |
    Remove all users from the shadow group:
    # sed -ri 's/(^shadow:[^:]*:[^:]*:)([^:]+$)/\1/' /etc/group
  query: |
    SELECT 1 WHERE NOT EXISTS (
      SELECT * FROM user_groups ug
      JOIN groups g ON ug.gid = g.gid
      WHERE g.groupname = 'shadow'
    );
  purpose: Informational
  tags: compliance, CIS, CIS_Level1, CIS-ubuntu-24.04-7.2.2
  contributors: allenhouchins

---
apiVersion: v1
kind: policy
spec:
  name: CIS - all groups in /etc/passwd exist in /etc/group
  platforms: Linux
  platform: linux
  description: |
    Over time, system administration errors and changes can lead to groups being defined in /etc/passwd but not in /etc/group.
  resolution: |
    Analyze the output of the Audit step and perform the appropriate action to correct any discrepancies found.
  query: |
    SELECT 1 WHERE NOT EXISTS (
      SELECT u.* FROM users u 
      LEFT JOIN groups g ON u.gid = g.gid 
      WHERE g.gid IS NULL
    );
  purpose: Informational
  tags: compliance, CIS, CIS_Level1, CIS-ubuntu-24.04-7.2.3
  contributors: allenhouchins

---
apiVersion: v1
kind: policy
spec:
  name: CIS - no duplicate UIDs exist
  platforms: Linux
  platform: linux
  description: |
    Although the useradd program will not let you create a duplicate User ID (UID), it is possible for an administrator to manually edit the /etc/passwd file and change the UID field.
  resolution: |
    Based on the results of the audit script, establish unique UIDs and review all files owned by the shared UIDs to determine which UID they are supposed to belong to.
  query: |
    SELECT 1 WHERE NOT EXISTS (
      SELECT uid, COUNT(*) as count 
      FROM users 
      GROUP BY uid 
      HAVING count > 1
    );
  purpose: Informational
  tags: compliance, CIS, CIS_Level1, CIS-ubuntu-24.04-7.2.4
  contributors: allenhouchins

---
apiVersion: v1
kind: policy
spec:
  name: CIS - no duplicate GIDs exist
  platforms: Linux
  platform: linux
  description: |
    Although the groupadd program will not let you create a duplicate Group ID (GID), it is possible for an administrator to manually edit the /etc/group file and change the GID field.
  resolution: |
    Based on the results of the audit script, establish unique GIDs and review all files owned by the shared GIDs to determine which GID they are supposed to belong to.
  query: |
    SELECT 1 WHERE NOT EXISTS (
      SELECT gid, COUNT(*) as count 
      FROM groups 
      GROUP BY gid 
      HAVING count > 1
    );
  purpose: Informational
  tags: compliance, CIS, CIS_Level1, CIS-ubuntu-24.04-7.2.5
  contributors: allenhouchins

---
apiVersion: v1
kind: policy
spec:
  name: CIS - no duplicate user names exist
  platforms: Linux
  platform: linux
  description: |
    Although the useradd program will not let you create a duplicate user name, it is possible for an administrator to manually edit the /etc/passwd file and change the user name.
  resolution: |
    Based on the results of the audit script, establish unique usernames for all users.
  query: |
    SELECT 1 WHERE NOT EXISTS (
      SELECT username, COUNT(*) as count 
      FROM users 
      GROUP BY username 
      HAVING count > 1
    );
  purpose: Informational
  tags: compliance, CIS, CIS_Level1, CIS-ubuntu-24.04-7.2.6
  contributors: allenhouchins

---
apiVersion: v1
kind: policy
spec:
  name: CIS - no duplicate group names exist
  platforms: Linux
  platform: linux
  description: |
    Although the groupadd program will not let you create a duplicate group name, it is possible for an administrator to manually edit the /etc/group file and change the group name.
  resolution: |
    Based on the results of the audit script, establish unique names for all groups.
  query: |
    SELECT 1 WHERE NOT EXISTS (
      SELECT groupname, COUNT(*) as count 
      FROM groups 
      GROUP BY groupname 
      HAVING count > 1
    );
  purpose: Informational
  tags: compliance, CIS, CIS_Level1, CIS-ubuntu-24.04-7.2.7
  contributors: allenhouchins

---
apiVersion: v1
kind: policy
spec:
  name: CIS - paths in PATH variable are not writable by non-root users
  platforms: Linux
  platform: linux
  description: |
    If the current working directory (.) or the parent working directory (..) is included in the PATH variable, an attacker could place a malicious program in those locations.
  resolution: |
    Ensure that no users have . or .. in their PATH variable.
  query: |
    SELECT 1 WHERE NOT EXISTS (
      SELECT * FROM processes 
      WHERE cmdline LIKE '%PATH=%.:%' 
        OR cmdline LIKE '%PATH=.:/%' 
        OR cmdline LIKE '%PATH=%:.:%' 
        OR cmdline LIKE '%PATH=%::%'
    );
  purpose: Informational
  tags: compliance, CIS, CIS_Level1, CIS-ubuntu-24.04-7.2.8
  contributors: allenhouchins

---
apiVersion: v1
kind: policy
spec:
  name: CIS - root is the only UID 0 account
  platforms: Linux
  platform: linux
  description: |
    Any account with UID 0 has superuser privileges on the system.
  resolution: |
    Remove any users other than root with UID 0 or assign them a new UID if appropriate.
  query: |
    SELECT 1 WHERE NOT EXISTS (
      SELECT * FROM users 
      WHERE uid = 0 
      AND username != 'root'
    );
  purpose: Informational
  tags: compliance, CIS, CIS_Level1, CIS-ubuntu-24.04-7.2.9
  contributors: allenhouchins

---
apiVersion: v1
kind: policy
spec:
  name: CIS - all users home directories exist
  platforms: Linux
  platform: linux
  description: |
    Users can be defined in /etc/passwd without a home directory or with a home directory that does not actually exist.
  resolution: |
    If any users' home directories do not exist, create them and make sure the respective user owns the directory.
  query: |
    SELECT 1 WHERE NOT EXISTS (
      SELECT u.* FROM users u 
      LEFT JOIN file f ON u.directory = f.path 
      WHERE f.path IS NULL 
      AND u.uid >= 1000 
      AND u.shell NOT IN ('/usr/sbin/nologin', '/bin/false', '/sbin/nologin')
    );
  purpose: Informational
  tags: compliance, CIS, CIS_Level1, CIS-ubuntu-24.04-7.2.10
  contributors: allenhouchins

---
apiVersion: v1
kind: policy
spec:
  name: CIS - users own their home directories
  platforms: Linux
  platform: linux
  description: |
    The user home directory is space defined for the particular user to set local environment variables and to store personal files.
  resolution: |
    Change the ownership of any home directories that are not owned by the defined user to the correct user.
  query: |
    SELECT 1 WHERE NOT EXISTS (
      SELECT u.*, f.uid as file_uid 
      FROM users u 
      JOIN file f ON u.directory = f.path 
      WHERE u.uid != f.uid 
      AND u.uid >= 1000 
      AND u.shell NOT IN ('/usr/sbin/nologin', '/bin/false', '/sbin/nologin')
    );
  purpose: Informational
  tags: compliance, CIS, CIS_Level1, CIS-ubuntu-24.04-7.2.11
  contributors: allenhouchins

---
apiVersion: v1
kind: policy
spec:
  name: CIS - users home directories permissions are 750 or more restrictive
  platforms: Linux
  platform: linux
  description: |
    While the system administrator can establish secure permissions for users' home directories, the users can easily override these.
  resolution: |
    Making global modifications to user home directories without alerting the user community can result in unexpected outages.
  query: |
    SELECT 1 WHERE NOT EXISTS (
      SELECT u.*, f.mode 
      FROM users u 
      JOIN file f ON u.directory = f.path 
      WHERE (
        f.mode LIKE '%1' OR 
        f.mode LIKE '%2' OR 
        f.mode LIKE '%3' OR 
        f.mode LIKE '%4' OR 
        f.mode LIKE '%5' OR 
        f.mode LIKE '%6' OR 
        f.mode LIKE '%7'
      ) 
      AND u.uid >= 1000 
      AND u.shell NOT IN ('/usr/sbin/nologin', '/bin/false', '/sbin/nologin')
    );
  purpose: Informational
  tags: compliance, CIS, CIS_Level1, CIS-ubuntu-24.04-7.2.12
  contributors: allenhouchins

---
apiVersion: v1
kind: policy
spec:
  name: CIS - users dot files are not group or world writable
  platforms: Linux
  platform: linux
  description: |
    Group or world-writable user configuration files may enable malicious users to steal or modify other users' data.
  resolution: |
    Making global modifications to users' files without alerting the user community can result in unexpected outages.
  query: |
    SELECT 1 WHERE NOT EXISTS (
      SELECT f.* FROM file f 
      JOIN users u ON f.path LIKE u.directory || '/.%' 
      WHERE u.uid >= 1000 
      AND u.shell NOT IN ('/usr/sbin/nologin', '/bin/false', '/sbin/nologin') 
      AND (f.mode LIKE '%2%' OR f.mode LIKE '%6%')
    );
  purpose: Informational
  tags: compliance, CIS, CIS_Level1, CIS-ubuntu-24.04-7.2.13
  contributors: allenhouchins

---
apiVersion: v1
kind: policy
spec:
  name: CIS - no users have .forward files
  platforms: Linux
  platform: linux
  description: |
    The .forward file specifies an email address to which mail for the user is redirected.
  resolution: |
    Making global modifications to users' files without alerting the user community can result in unexpected outages and unhappy users.
  query: |
    SELECT 1 WHERE NOT EXISTS (
      SELECT * FROM file f
      JOIN users u ON f.path = u.directory || '/.forward'
      WHERE u.uid >= 1000 
      AND u.shell NOT IN ('/usr/sbin/nologin', '/bin/false', '/sbin/nologin')
    );
  purpose: Informational
  tags: compliance, CIS, CIS_Level1, CIS-ubuntu-24.04-7.2.14
  contributors: allenhouchins

---
apiVersion: v1
kind: policy
spec:
  name: CIS - no users have .netrc files
  platforms: Linux
  platform: linux
  description: |
    The .netrc file contains data for logging into a remote host for file transfers via FTP.
  resolution: |
    Making global modifications to users' files without alerting the user community can result in unexpected outages and unhappy users. Therefore, it is recommended that a monitoring policy be established to report user .netrc file usage and determine the action to be taken in accordance with site policy.
  query: |
    SELECT 1 WHERE NOT EXISTS (
      SELECT * FROM file f
      JOIN users u ON f.path = u.directory || '/.netrc'
      WHERE u.uid >= 1000 
      AND u.shell NOT IN ('/usr/sbin/nologin', '/bin/false', '/sbin/nologin')
    );
  purpose: Informational
  tags: compliance, CIS, CIS_Level1, CIS-ubuntu-24.04-7.2.21
  contributors: allenhouchins

---
apiVersion: v1
kind: policy
spec:
  name: CIS - users .netrc Files are not group or world accessible
  platforms: Linux
  platform: linux
  description: |
    While the system administrator can establish secure permissions for users' .netrc files, the users can easily override these.
  resolution: |
    Making global modifications to users' files without alerting the user community can result in unexpected outages and unhappy users. Therefore, it is recommended that a monitoring policy be established to report user .netrc file permissions and determine the action to be taken in accordance with site policy.
  query: |
    SELECT 1 WHERE NOT EXISTS (
      SELECT * FROM file f
      JOIN users u ON f.path = u.directory || '/.netrc'
      WHERE u.uid >= 1000 
      AND u.shell NOT IN ('/usr/sbin/nologin', '/bin/false', '/sbin/nologin')
      AND (f.mode & 0077) != 0
    );
  purpose: Informational
  tags: compliance, CIS, CIS_Level1, CIS-ubuntu-24.04-7.2.22
  contributors: allenhouchins

---
apiVersion: v1
kind: policy
spec:
  name: CIS - no users have .rhosts files
  platforms: Linux
  platform: linux
  description: |
    While no .rhosts files are shipped by default, users can easily create them.
  resolution: |
    Making global modifications to users' files without alerting the user community can result in unexpected outages and unhappy users. Therefore, it is recommended that a monitoring policy be established to report user .rhosts files and determine the action to be taken in accordance with site policy.
  query: |
    SELECT 1 WHERE NOT EXISTS (
      SELECT * FROM file f
      JOIN users u ON f.path = u.directory || '/.rhosts'
      WHERE u.uid >= 1000 
      AND u.shell NOT IN ('/usr/sbin/nologin', '/bin/false', '/sbin/nologin')
    );
  purpose: Informational
  tags: compliance, CIS, CIS_Level1, CIS-ubuntu-24.04-7.2.23
  contributors: allenhouchins

# =============================================================================
# COMPLETE CIS UBUNTU 24.04 BENCHMARK SUMMARY
# =============================================================================
# 
# This complete master file includes ALL CIS Ubuntu 24.04 LTS benchmark policies:
#  150+ security policies covering ALL CIS benchmark sections
#  Both Level 1 (basic) and Level 2 (advanced) controls
#  All queries use only Fleet-supported osquery tables
#  All queries return 1 for compliant devices, 0 for non-compliant
#  Proper YAML format for Fleet deployment
#  Comprehensive resolution steps for each policy
#  Appropriate CIS control tagging
#
# COVERAGE BY SECTION:
# - Section 1: Initial Setup (Filesystem, Software Updates, MAC, Boot, Process Hardening)
# - Section 2: Services (Time Sync, Special Purpose Services, Client Services)
# - Section 3: Network Configuration (Network Parameters, Firewall)
# - Section 4: Logging and Auditing (rsyslog, journald, auditd)
# - Section 5: Access Control (SSH, PAM, User Environment)
# - Section 6: System Maintenance (covered in sections 4 and 7)
# - Section 7: System File Permissions and User/Group Settings
#
# NOTES:
# - Some policies may require customization for your environment
# - Review service disabling policies against operational requirements
# - Test in non-production environment first
# - Consider phased rollout for production systems
